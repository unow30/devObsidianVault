## ğŸ“‹ ê°œìš”

í˜„ì¬ í”„ë¡œì íŠ¸ëŠ” mock ë°ì´í„°ë¥¼ ì‚¬ìš© ì¤‘ì´ë©°, Supabase ë°±ì—”ë“œì™€ ì—°ë™í•˜ê¸° ìœ„í•œ ì¢…í•© ê³„íšì…ë‹ˆë‹¤.
ì´ ë¬¸ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¶€í„° í”„ë¡ íŠ¸ì—”ë“œ ì—°ê²°ê¹Œì§€ ë‹¨ê³„ë³„ êµ¬í˜„ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.

---

## Phase 1: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì„¤ê³„ & êµ¬ì„±

### 1.1 ì£¼ìš” í…Œì´ë¸” ìƒì„±

#### `cities` í…Œì´ë¸”
ë„ì‹œì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. `City` ì¸í„°í˜ì´ìŠ¤(types/city.ts)ì™€ ë§¤í•‘ë©ë‹ˆë‹¤.

```
- id (UUID, Primary Key)
- rank (Integer) - ë„ì‹œ ìˆœìœ„
- name (String) - ë„ì‹œëª…
- region (String) - ì§€ì—­ (ì˜ˆ: ê°•ì›, ì œì£¼)
- province (String) - ê´‘ì—­ì‹œ/ë„
- image (String) - ë„ì‹œ ëŒ€í‘œ ì´ë¯¸ì§€ URL
- tags (Text Array) - íƒœê·¸ ëª©ë¡
- budget (String) - ì˜ˆì‚° ë²”ìœ„ (under100, 100to200, over200)
- environment (Text Array) - í™˜ê²½ íŠ¹ì„± (nature, urban, cafe, coworking)
- best_season (String) - ìµœê³  ê³„ì ˆ (spring, summer, fall, winter)
- ktx_time (Decimal) - ì„œìš¸ê¹Œì§€ KTX ì†Œìš”ì‹œê°„ (ì‹œê°„)
- cafe_count (Integer) - ì¹´í˜/ì‘ì—…ê³µê°„ ê°œìˆ˜
- created_at (Timestamp)
- updated_at (Timestamp)
```

#### `city_metrics` í…Œì´ë¸”
ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€í•˜ëŠ” ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

```
- id (UUID, Primary Key)
- city_id (UUID, Foreign Key â†’ cities.id)
- current_temp (Decimal) - í˜„ì¬ ê¸°ì˜¨ (Â°C)
- aqi (Integer) - ë¯¸ì„¸ë¨¼ì§€ AQI
- aqi_label (String) - ë¯¸ì„¸ë¨¼ì§€ ë¼ë²¨ (ì¢‹ìŒ, ë³´í†µ, ë‚˜ì¨, ë§¤ìš°ë‚˜ì¨)
- internet_speed (Decimal) - ì¸í„°ë„· ì†ë„ (Mbps)
- monthly_budget (Integer) - ì›” ìƒí™œë¹„ (ë§Œì›)
- rent_studio (Integer) - ì›ë£¸ ì›”ì„¸ (ë§Œì›)
- data_source (String) - ë°ì´í„° ì¶œì²˜ (api, user_input)
- created_at (Timestamp)
- updated_at (Timestamp)
```

#### `user_ratings` í…Œì´ë¸”
ì‚¬ìš©ìì˜ í‰ê°€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

```
- id (UUID, Primary Key)
- city_id (UUID, Foreign Key â†’ cities.id)
- user_id (UUID, Foreign Key â†’ auth.users)
- overall_score (Decimal, 1-5) - ì¢…í•© ì ìˆ˜
- likes (Integer) - ì¢‹ì•„ìš” ì—¬ë¶€ (1/-1/0)
- created_at (Timestamp)
- updated_at (Timestamp)
- Unique Constraint: (city_id, user_id)
```

#### `user_reviews` í…Œì´ë¸”
ì‚¬ìš©ìì˜ ìƒì„¸ ë¦¬ë·° í…ìŠ¤íŠ¸ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

```
- id (UUID, Primary Key)
- city_id (UUID, Foreign Key â†’ cities.id)
- user_id (UUID, Foreign Key â†’ auth.users)
- title (String) - ë¦¬ë·° ì œëª©
- content (Text) - ë¦¬ë·° ë‚´ìš©
- rating (Integer, 1-5) - í‰ì 
- created_at (Timestamp)
- updated_at (Timestamp)
```

#### `users` í…Œì´ë¸” (Supabase Auth ì—°ë™)
Supabase Auth ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¥í•©ë‹ˆë‹¤.

```
- id (UUID, Primary Key) - auth.usersì™€ ë™ì¼
- email (String)
- username (String, Unique)
- profile_image (String)
- bio (Text)
- created_at (Timestamp)
- updated_at (Timestamp)
```

---

## Phase 2: Row Level Security (RLS) ì •ì±…

### 2.1 cities í…Œì´ë¸”
```
- SELECT: Public (ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥)
- INSERT: False (ê´€ë¦¬ìë§Œ)
- UPDATE: False (ê´€ë¦¬ìë§Œ)
- DELETE: False (ê´€ë¦¬ìë§Œ)
```

### 2.2 city_metrics í…Œì´ë¸”
```
- SELECT: Public
- INSERT: False (API ë˜ëŠ” ê´€ë¦¬ìë§Œ)
- UPDATE: False (API ë˜ëŠ” ê´€ë¦¬ìë§Œ)
- DELETE: False
```

### 2.3 user_ratings í…Œì´ë¸”
```
- SELECT: Public
- INSERT: Authenticated (ì¸ì¦ëœ ì‚¬ìš©ì)
- UPDATE: Authenticated (ìì‹ ì˜ í‰ê°€ë§Œ)
- DELETE: Authenticated (ìì‹ ì˜ í‰ê°€ë§Œ)
- Policy: auth.uid() = user_id
```

### 2.4 user_reviews í…Œì´ë¸”
```
- SELECT: Public
- INSERT: Authenticated
- UPDATE: Authenticated (ìì‹ ì˜ ë¦¬ë·°ë§Œ)
- DELETE: Authenticated (ìì‹ ì˜ ë¦¬ë·°ë§Œ)
- Policy: auth.uid() = user_id
```

### 2.5 users í…Œì´ë¸”
```
- SELECT: Public (username, profile_imageë§Œ)
- INSERT: False (Auth íŠ¸ë¦¬ê±°ë¡œ ìë™ ìƒì„±)
- UPDATE: Authenticated (ìì‹ ì˜ ì •ë³´ë§Œ)
- DELETE: False
```

---

## Phase 3: ì¸ì¦ ì‹œìŠ¤í…œ êµ¬ì¶•

### 3.1 Supabase Auth ì„¤ì •
- ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í™œì„±í™”
- ì´ë©”ì¼ í™•ì¸ í™œì„±í™” (ì„ íƒ)
- ì†Œì…œ ë¡œê·¸ì¸ (Google, GitHub) - í–¥í›„

### 3.2 í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •

**í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬:**
- `@supabase/supabase-js` - í´ë¼ì´ì–¸íŠ¸ SDK
- `@supabase/ssr` - Next.js SSR ì§€ì›

**í™˜ê²½ë³€ìˆ˜ (.env.local):**
```
NEXT_PUBLIC_SUPABASE_URL=https://[PROJECT_ID].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[ANON_KEY]
SUPABASE_SERVICE_ROLE_KEY=[SERVICE_ROLE_KEY] (ì„œë²„ ì „ìš©)
```

### 3.3 í˜„ì¬ êµ¬í˜„ í™œìš©
- `app/login/page.tsx` - ë¡œê·¸ì¸ í˜ì´ì§€ (ì´ë¯¸ êµ¬í˜„)
- `app/register/page.tsx` - íšŒì›ê°€ì… í˜ì´ì§€ (ì´ë¯¸ êµ¬í˜„)
- `middleware.ts` - ì„¸ì…˜ ê´€ë¦¬ (ì´ë¯¸ êµ¬í˜„)

---

## Phase 4: API ì—”ë“œí¬ì¸íŠ¸ ê°œë°œ

### 4.1 ë°ì´í„° ì¡°íšŒ API

#### GET `/api/cities`
**ìš©ë„:** í™ˆí˜ì´ì§€ ë„ì‹œ ëª©ë¡ ì¡°íšŒ

**ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°:**
```
?sort=score|budget-low|budget-high|internet|reviews
?region=all|seoul|gangwon|...
?budget=under100|100to200|over200
?environment=nature|urban|cafe|coworking
?limit=12&offset=0
```

**ì‘ë‹µ:**
```json
{
  "data": [
    {
      "id": "uuid",
      "rank": 1,
      "name": "ì œì£¼ì‹œ",
      "province": "ì œì£¼íŠ¹ë³„ìì¹˜ë„",
      ...
      "average_score": 4.5,
      "review_count": 123
    }
  ],
  "total": 15,
  "page": 1
}
```

#### GET `/api/cities/[slug]`
**ìš©ë„:** ë„ì‹œ ìƒì„¸ í˜ì´ì§€

**ì‘ë‹µ:**
```json
{
  "city": {...},
  "metrics": {...},
  "recent_reviews": [...],
  "user_rating": {...} (ì¸ì¦ëœ ê²½ìš°)
}
```

#### GET `/api/cities/[slug]/metrics`
**ìš©ë„:** ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ ì¡°íšŒ

**ì‘ë‹µ:**
```json
{
  "current_temp": 15.2,
  "aqi": 45,
  "aqi_label": "ì¢‹ìŒ",
  "internet_speed": 150.5,
  "monthly_budget": 180,
  "rent_studio": 45
}
```

### 4.2 ì‚¬ìš©ì ìƒí˜¸ì‘ìš© API

#### POST `/api/cities/[slug]/rate`
**ìš©ë„:** ë„ì‹œ í‰ê°€ ì œì¶œ

**ìš”ì²­:**
```json
{
  "overall_score": 4,
  "likes": 1
}
```

**ìš”êµ¬:** ì¸ì¦ëœ ì‚¬ìš©ì

---

#### POST `/api/cities/[slug]/review`
**ìš©ë„:** ë¦¬ë·° ì‘ì„±

**ìš”ì²­:**
```json
{
  "title": "ì¢‹ì€ ë„ì‹œ",
  "content": "ìƒí™œí•˜ê¸° í¸í•˜ê³ ...",
  "rating": 4
}
```

**ìš”êµ¬:** ì¸ì¦ëœ ì‚¬ìš©ì

---

#### PUT `/api/cities/[slug]/rate`
**ìš©ë„:** í‰ê°€ ìˆ˜ì •

**ìš”ì²­:**
```json
{
  "overall_score": 5,
  "likes": 0
}
```

**ìš”êµ¬:** í•´ë‹¹ í‰ê°€ ì‘ì„±ì

---

#### DELETE `/api/cities/[slug]/review/[reviewId]`
**ìš©ë„:** ë¦¬ë·° ì‚­ì œ

**ìš”êµ¬:** ë¦¬ë·° ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ì

---

### 4.3 í•„í„°ë§ ë° ì •ë ¬

í•„í„°ë§ê³¼ ì •ë ¬ì€ **ë°±ì—”ë“œ ì¿¼ë¦¬**ë¡œ ì²˜ë¦¬í•˜ì—¬ ì„±ëŠ¥ ìµœì í™”:

```sql
-- ì˜ˆì‹œ: ê°•ì› ì§€ì—­, ìƒí™œë¹„ ë‚®ì€ìˆœ
SELECT * FROM cities
WHERE region = 'gangwon'
ORDER BY average_monthly_budget ASC
```

---

## Phase 5: í”„ë¡ íŠ¸ì—”ë“œ ë°ì´í„° ì—°ê²°

### 5.1 ì»´í¬ë„ŒíŠ¸ ìˆ˜ì • ì‚¬í•­

#### `app/page.tsx`
- `getCitiesByRank()` (mock) â†’ `GET /api/cities` (API í˜¸ì¶œ)
- í•„í„°/ì •ë ¬ ê°’ ë³€ê²½ ì‹œ ë™ì ìœ¼ë¡œ ë°ì´í„° ì¬ì¡°íšŒ

#### `app/city/[citySlug]/page.tsx`
- ë‹¨ì¼ ë„ì‹œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
- ì‚¬ìš©ì í‰ê°€/ë¦¬ë·° í‘œì‹œ
- ì¸ì¦ëœ ì‚¬ìš©ìëŠ” í‰ê°€/ë¦¬ë·° ì…ë ¥ í¼ ì œê³µ

#### `components/filters/FilterBar.tsx`
- í•„í„° ì„ íƒ ì‹œ API ì¿¼ë¦¬ ì—…ë°ì´íŠ¸
- URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ìƒíƒœ ìœ ì§€ (ë¶ë§ˆí¬ ê°€ëŠ¥)

#### `components/city/CityCardGrid.tsx`
- ë™ì  ë„ì‹œ ì¹´ë“œ ë Œë”ë§

### 5.2 ìƒíƒœ ê´€ë¦¬ (ì„ íƒ)

**ì˜µì…˜ 1: React Query (ê¶Œì¥)**
```typescript
const { data: cities, isLoading } = useQuery({
  queryKey: ['cities', filters, sort],
  queryFn: () => fetchCities(filters, sort)
})
```

**ì˜µì…˜ 2: Zustand**
- ê°„ë‹¨í•œ ìƒíƒœ ê´€ë¦¬ (í•„í„°, ì •ë ¬ ê°’)

**ì˜µì…˜ 3: ë¡œì»¬ ìƒíƒœ**
- ë‹¨ìˆœ í•„í„°ë§ì€ URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ê´€ë¦¬

### 5.3 ë‚™ê´€ì  ì—…ë°ì´íŠ¸ (Optimistic Update)

ì‚¬ìš©ìê°€ í‰ê°€ë¥¼ ì œì¶œí•  ë•Œ:
1. UIì—ì„œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë‚™ê´€ì )
2. ë°±ê·¸ë¼ìš´ë“œì—ì„œ API í˜¸ì¶œ
3. ì‹¤íŒ¨ ì‹œ ì´ì „ ìƒíƒœë¡œ ë³µêµ¬

```typescript
// ì˜ˆì‹œ
const optimisticCity = {
  ...city,
  average_score: newScore,
  review_count: city.review_count + 1
}
```

### 5.4 ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì„ íƒ)

**Supabase Realtime** êµ¬ë…:
```typescript
supabase
  .channel('cities')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'user_ratings' },
    payload => console.log('New update:', payload)
  )
  .subscribe()
```

---

## Phase 6: ë°°í¬ & í”„ë¡œë•ì…˜ ì„¤ì •

### 6.1 í˜„ì¬ ì„¤ì • ìƒíƒœ

**`.mcp.json` í™•ì¸:**
```json
{
  "supabase": {
    "project-ref": "usjxfwdibmgsitzqhajb",
    "SUPABASE_ACCESS_TOKEN": "[í† í°]"
  }
}
```

### 6.2 í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬

**ë¡œì»¬ ê°œë°œ (.env.local):**
```
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
```

**í”„ë¡œë•ì…˜ (Vercel):**
- í™˜ê²½ë³€ìˆ˜ ì„¤ì •ì— ìœ„ ê°’ ì¶”ê°€

### 6.3 ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬

```bash
# ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
npm run supabase:migration:new create_cities_table

# ë¡œì»¬ í…ŒìŠ¤íŠ¸
npm run supabase:reset

# íƒ€ì… ìƒì„±
npm run supabase:gen:types
```

### 6.4 ì„±ëŠ¥ ìµœì í™” ì „ëµ

| í•­ëª© | ì „ëµ |
|------|------|
| **ë°ì´í„° ìºì‹±** | ë„ì‹œ ì •ë³´: 1ì‹œê°„, ë©”íŠ¸ë¦­: 10ë¶„ |
| **í˜ì´ì§€ ìƒì„±** | ISR (Incremental Static Regeneration) í™œìš© |
| **ì´ë¯¸ì§€ ìµœì í™”** | Next.js Image ì»´í¬ë„ŒíŠ¸ ì‚¬ìš© |
| **DB ì¸ë±ì‹±** | `cities(region)`, `user_ratings(city_id, user_id)` |

---

## ğŸ”§ ê¸°ìˆ ì  ê³ ë ¤ì‚¬í•­

### íƒ€ì… ì•ˆì •ì„±
```bash
# Supabase ìŠ¤í‚¤ë§ˆì—ì„œ TypeScript íƒ€ì… ìë™ ìƒì„±
npm run supabase:gen:types
```

ìƒì„±ëœ `types/database.types.ts`ë¥¼ API í•¸ë“¤ëŸ¬ì—ì„œ í™œìš©:
```typescript
import { Database } from '@/types/database.types'

type City = Database['public']['Tables']['cities']['Row']
```

### ì—ëŸ¬ ì²˜ë¦¬
- API ì˜¤ë¥˜: "ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€
- RLS ìœ„ë°˜: ì‚¬ìš©ì í”¼ë“œë°± (ì˜ˆ: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤")
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì¬ì‹œë„ ë¡œì§

### ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] RLS ì •ì±… ëª¨ë‘ ì„¤ì •
- [ ] ë¯¼ê°í•œ í‚¤ëŠ” ì„œë²„ í™˜ê²½ë³€ìˆ˜ë§Œ ì‚¬ìš©
- [ ] í´ë¼ì´ì–¸íŠ¸ëŠ” ANON_KEYë§Œ ë…¸ì¶œ
- [ ] API ë¼ìš°íŠ¸ì—ì„œ `auth.uid()` ê²€ì¦
- [ ] SQL Injection ë°©ì§€ (Supabase SDK ì‚¬ìš©)

### ì„±ëŠ¥ ëª©í‘œ
- ì´ˆê¸° ë¡œë”© ì‹œê°„: 3ì´ˆ ì´ë‚´ (LCP)
- ì¹´ë“œ ë Œë”ë§: 12ê°œ ì¹´ë“œ 1ì´ˆ ì´ë‚´
- API ì‘ë‹µ ì‹œê°„: 500ms ì´ë‚´

---

## ğŸ“… êµ¬í˜„ ìˆœì„œ (ê¶Œì¥)

1. **Phase 1** - ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì„¤ê³„ ë° ë§ˆì´ê·¸ë ˆì´ì…˜
2. **Phase 2** - RLS ì •ì±… ì„¤ì • (ë³´ì•ˆ)
3. **Phase 3** - ì¸ì¦ ì‹œìŠ¤í…œ ì—°ë™ (ì´ë¯¸ ë¶€ë¶„ êµ¬í˜„ë¨)
4. **Phase 4** - API ì—”ë“œí¬ì¸íŠ¸ ê°œë°œ
5. **Phase 5** - í”„ë¡ íŠ¸ì—”ë“œ ì»´í¬ë„ŒíŠ¸ ì—°ê²°
6. **Phase 6** - ë°°í¬ ë° ì„±ëŠ¥ ìµœì í™”

---

## ì°¸ê³  ìë£Œ

- Supabase ê³µì‹ ë¬¸ì„œ: https://supabase.com/docs
- Next.js + Supabase: https://supabase.com/docs/guides/getting-started/quickstarts/nextjs
- Row Level Security: https://supabase.com/docs/guides/auth/row-level-security
- Realtime: https://supabase.com/docs/guides/realtime
