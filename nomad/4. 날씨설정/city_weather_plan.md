# 월별 날씨 정보 Supabase 저장 및 그래프 표시 기능 계획  
  
## 1. 기능 분석  
  
### 문제와 목표  
- **현재 상태**: 월별 날씨 데이터가 `lib/mock-data.ts`에 하드코딩되어 있으며, Supabase DB에는 저장되지 않음  
- **목표**: 월별 날씨 데이터를 Supabase에 저장하고, 기존 WeatherChart 컴포넌트에서 DB 데이터를 조회하여 표시  
- **기대 결과**: Mock 데이터에서 DB 기반 시스템으로 전환하여 확장 가능한 아키텍처 구축[1]  
  
### 범위  
**포함되는 것**:  
- `monthly_weather` 테이블 생성 (마이그레이션)  
- 15개 도시의 월별 날씨 임의 데이터 시드 (`seed.sql` 또는 별도 스크립트)  
- WeatherChart 컴포넌트의 DB 데이터 연동  
- TypeScript 타입 자동 생성  
- RLS 정책 설정 (읽기 전용 공개)  
  
**제외되는 것**:  
- 실제 날씨 API 연동 (향후 Phase 3에서 진행)  
- 날씨 데이터 수정/삭제 기능  
- 사용자별 날씨 알림 기능  
- 히스토리 관리 (현재는 최신 데이터만)  
  
### 주요 사용자 시나리오  
1. 도시 상세 페이지 방문: 사용자가 특정 도시(예: 제주시) 상세 페이지 접속 → DB에서 12개월 날씨 데이터 조회 → WeatherChart에 표시  
2. 홈페이지 도시 카드: 도시 카드에는 현재 기온만 표시하므로 이번 작업 범위 외  
3. 날씨 데이터 없는 경우: 새 도시 추가 시 날씨 데이터 없을 수 있음 → 에러 핸들링 (기존 로직 유지)  
  
***  
  
## 2. 작업 분해  
  
### 작업 1: DB 스키마 설계 및 마이그레이션 생성  
**설명**: `monthly_weather` 테이블을 생성하는 SQL 마이그레이션 파일 작성  
- 컬럼: `id`, `city_id` (FK), `month`, `avg_temp`, `max_temp`, `min_temp`, `rainfall`, `created_at`, `updated_at`  
- 제약조건: `UNIQUE(city_id, month)` - 한 도시의 특정 월은 1개 레코드만  
- 인덱스: `city_id`에 인덱스 추가 (조회 성능)  
  
**예상 시간**: 1시간  **선행 작업**: 없음  **완료 조건**:  
- `supabase/migrations/{timestamp}_create_monthly_weather.sql` 파일 생성  
- `npm run supabase:reset` 실행 시 테이블 정상 생성  
- Supabase Studio에서 테이블 구조 확인  
  
**위험 요소**:  
- (낮음) 컬럼 타입 선택 오류 (`DECIMAL` vs `INTEGER`)  
- (낮음) FK 참조 무결성 설정 누락  
  
### 작업 2: RLS 정책 설정  
**설명**: `monthly_weather` 테이블에 대한 Row Level Security 정책 추가  
- 읽기(`SELECT`): 모든 사용자 공개 (인증 불필요)  
- 쓰기(`INSERT/UPDATE/DELETE`): 관리자만 가능 (현재 단계에서는 제한)  
  
**예상 시간**: 30분  **선행 작업**: 작업 1    
**완료 조건**:  
- RLS 정책이 마이그레이션 파일에 포함  
- 인증 없이 SELECT 쿼리 성공  
- 일반 사용자의 INSERT/UPDATE 시도 실패  
  
**위험 요소**:  
- (낮음) RLS 정책 문법 오류  
  
### 작업 3: 임의 데이터 시드 작성  
**설명**: 15개 도시 × 12개월 = 180개 레코드의 임의 날씨 데이터 생성  
- 기존 `lib/mock-data.ts`의 monthlyWeather 데이터 참고  
- `supabase/seed.sql`에 INSERT 문 추가 또는 별도 마이그레이션  
- 각 도시별 현실적인 한국 기후 패턴 반영  
  
**예상 시간**: 2시간  **선행 작업**: 작업 1    
**완료 조건**:  
- 180개 레코드 INSERT 성공  
- Supabase Studio에서 데이터 확인  
- 각 도시별 12개월 데이터 완비  
  
**위험 요소**:  
- (중간) 데이터 생성 스크립트 작성 시간 소요 (반복 작업)  
- (낮음) `city_id` FK 매칭 오류  
  
### 작업 4: TypeScript 타입 자동 생성  
**설명**: Supabase 스키마 변경 반영을 위한 타입 재생성  
- `npm run supabase:gen:types` 실행  
- `types/database.types.ts` 업데이트 확인  
- MonthlyWeather 타입과 DB 스키마 일치 검증  
  
**예상 시간**: 15분  **선행 작업**: 작업 1, 2    
**완료 조건**:  
- `types/database.types.ts`에 `monthly_weather` 테이블 타입 포함  
- TypeScript 컴파일 에러 없음  
  
**위험 요소**:  
- (없음) 자동화된 작업  
  
### 작업 5: Supabase 쿼리 함수 작성  
**설명**: 월별 날씨 데이터를 조회하는 서버 사이드 함수 생성  
- `utils/supabase/queries/weather.ts` 또는 유사 경로 생성  
- `getMonthlyWeather(cityId: string)` 함수 구현  
- Supabase 서버 클라이언트 사용 (`utils/supabase/server.ts`)  
- 에러 핸들링 포함  
  
**예상 시간**: 1.5시간  **선행 작업**: 작업 3, 4    
**완료 조건**:  
- 함수 호출 시 12개 MonthlyWeather 객체 배열 반환  
- 데이터 없는 경우 빈 배열 반환  
- 에러 발생 시 적절한 에러 메시지  
  
**위험 요소**:  
- (낮음) Supabase 클라이언트 import 경로 오류  
- (낮음) 타입 변환 오류 (DB → TypeScript)  
  
### 작업 6: WeatherChart 컴포넌트 리팩토링  
**설명**: 기존 Mock 데이터에서 DB 데이터로 전환  
- `components/city/WeatherChart.tsx` 수정  
- Props에서 `city.monthlyWeather` 대신 DB 조회 결과 사용  
- 또는 부모 컴포넌트에서 DB 데이터 fetch 후 전달  
  
**세부 옵션**:  
- **Option A**: WeatherChart를 서버 컴포넌트로 변경하여 직접 DB 조회  
- **Option B**: 부모 컴포넌트(`CityDetail`)에서 조회 후 props로 전달 (현재 구조 유지)  
  
**예상 시간**: 2시간  **선행 작업**: 작업 5    
**완료 조건**:  
- WeatherChart가 DB 데이터 정상 표시  
- Mock 데이터 참조 코드 제거 또는 fallback으로 변경  
- 에러 핸들링 유지 (데이터 없을 때)  
  
**위험 요소**:  
- (중간) 클라이언트 컴포넌트 → 서버 컴포넌트 전환 시 Recharts 호환성 문제  
- (낮음) Props 전달 구조 변경 시 타입 에러  
  
### 작업 7: 도시 상세 페이지 통합  
**설명**: `app/city/[citySlug]/page.tsx`에서 날씨 데이터 조회 로직 통합  
- 기존 Mock 데이터 대신 DB 쿼리 사용  
- city 정보 조회 시 `monthly_weather`도 함께 조회 (JOIN 또는 별도 쿼리)  
- 성능 최적화 (N+1 쿼리 방지)  
  
**예상 시간**: 1.5시간  **선행 작업**: 작업 6    
**완료 조건**:  
- 도시 상세 페이지 접속 시 DB 날씨 데이터 표시  
- 페이지 로딩 시간 2초 이내  
- Mock 데이터 의존성 제거  
  
**위험 요소**:  
- (중간) 기존 Mock 데이터 구조와 DB 구조 불일치 시 타입 에러  
- (낮음) 쿼리 성능 저하  
  
### 작업 8: 로컬 테스트 및 검증  
**설명**: 전체 플로우 테스트  
- `npm run supabase:start` → 로컬 DB 시작  
- `npm run dev` → 개발 서버 시작  
- 15개 도시 상세 페이지 모두 접속하여 날씨 차트 확인  
- 콘솔 에러 확인  
  
**예상 시간**: 1시간  **선행 작업**: 작업 7    
**완료 조건**:  
- 15개 도시 모두 날씨 차트 정상 렌더링  
- 콘솔 에러 0개  
- 네트워크 탭에서 Supabase 쿼리 성공 확인  
  
**위험 요소**:  
- (낮음) 특정 도시에서만 발생하는 데이터 오류  
  
### 작업 9: 코드 정리 및 주석 추가  
**설명**: Mock 데이터 레거시 코드 정리  
- `lib/mock-data.ts`에서 `monthlyWeather` 필드 제거 또는 deprecated 표시  
- 주석 추가: `// 현재는 DB에서 조회 (monthly_weather 테이블)`  
- 사용하지 않는 import 제거  
  
**예상 시간**: 30분  **선행 작업**: 작업 8    
**완료 조건**:  
- ESLint 경고 0개  
- 불필요한 코드 제거  
- 주석으로 변경사항 문서화  
  
**위험 요소**:  
- (없음) 단순 정리 작업  
  
***  
  
## 3. 실행 관점 정리  
  
### 병렬 처리 가능  
- 작업 2 (RLS 정책) + 작업 3 (시드 데이터) → 작업 1 완료 후 동시 진행 가능  
- 작업 4 (타입 생성) → 작업 1, 2 완료 후 독립 실행  
  
### 순차 처리 필요  
1. 작업 1 (스키마) → 모든 작업의 기반  
2. 작업 3 (시드) → 작업 5 (쿼리 함수) → 데이터 없으면 테스트 불가  
3. 작업 5 (쿼리) → 작업 6 (컴포넌트) → 작업 7 (페이지) → UI 레이어 순차 의존  
4. 작업 7 → 작업 8 (테스트) → 통합 완료 후 테스트  
  
### 우선순위 작업  
1. 작업 1 (스키마): 전체 작업의 기반  
2. 작업 3 (시드): 데이터 없으면 개발 불가  
3. 작업 6 (컴포넌트): UI 변경의 핵심 리스크  
  
***  
  
## 4. 테스트 계획  
  
### 기능 테스트  
  
- 제주시 상세 페이지: 12개월 날씨 차트 정상 표시  
- 부산 상세 페이지: 기온 라인 3개 (최고/평균/최저) 색상 구분  
- 강릉 상세 페이지: 강수량 그리드 레이아웃 반응형 동작  
- 데이터 없는 가상 도시: "날씨 정보가 없습니다" 메시지 표시  
  
### 통합 테스트  
  
- 로컬 Supabase → Next.js 개발 서버 → 브라우저 렌더링 전체 흐름  
- 페이지 새로고침 시 데이터 재조회 정상 동작  
- 15개 도시 모두 순차 접속하여 일관성 확인  
  
### 사용자 관점 테스트  
  
- 페이지 로딩 시간 2초 이내 (체감 속도)  
- 차트 애니메이션 부드러움 (Recharts)  
- 모바일 화면에서 강수량 그리드 3열 정렬  
- 태블릿에서 4열, PC에서 6열 확인  
  
 ---## 5. 산출물 및 체크포인트  
  
### 마일스톤  
  
1. MS1 (DB 준비 완료): 작업 1~4 완료 → Supabase에 테이블 + 데이터 준비  
2. MS2 (백엔드 로직 완료): 작업 5 완료 → 쿼리 함수 동작 확인  
3. MS3 (UI 통합 완료): 작업 6~7 완료 → 화면에 DB 데이터 표시  
4. MS4 (배포 준비): 작업 8~9 완료 → 로컬 테스트 통과  
  
### 체크포인트  
  
- CP1 (작업 1 후): Supabase Studio에서 테이블 스키마 확인  
  - 대응: 컬럼 누락 시 마이그레이션 수정  
- CP2 (작업 3 후): SELECT COUNT(*) FROM monthly_weather → 180 레코드  
  - 대응: 데이터 누락 시 INSERT 스크립트 재실행  
- CP3 (작업 5 후): 터미널에서 쿼리 함수 직접 호출 테스트  
  - 대응: 에러 발생 시 Supabase 클라이언트 설정 점검  
- CP4 (작업 7 후): 브라우저 Network 탭에서 Supabase 쿼리 응답 확인  
  - 대응: 빈 배열 반환 시 데이터/쿼리 로직 재점검  
  
### 문서화 항목  
  
- README.md 또는 CLAUDE.md 업데이트:  
  - "월별 날씨 데이터는 Supabase monthly_weather 테이블에서 조회"  
  - 마이그레이션 히스토리에 작업 1 파일명 추가  
- 마이그레이션 파일 내 주석:  
  - 테이블 용도, 컬럼 설명, 제약조건 의도 명시  
  
### 모니터링 (배포 후)  
  
- Supabase Dashboard에서 monthly_weather 테이블 쿼리 횟수 확인  
- 응답 시간 평균 < 200ms 목표  
- 에러 로그 모니터링 (RLS 정책 거부, FK 참조 오류 등)  
  
 ---## 6. 추가 원칙/조건  
  
### 개발 원칙  
  
- 최소 변경: 기존 WeatherChart 컴포넌트의 UI 로직은 최대한 유지  
- 타입 안정성: 모든 DB 응답에 TypeScript 타입 명시  
- 에러 핸들링: 데이터 없는 경우 사용자 친화적 메시지 표시  
- 성능: JOIN 쿼리 또는 단일 쿼리로 최적화 (N+1 방지)  
  
### 날씨 API 연동 대비  
  
- 확장 가능 설계: data_source 컬럼 추가 고려 (예: 'seed', 'api', 'manual')  
- 타임스탬프: created_at, updated_at으로 향후 API 갱신 주기 추적 준비  
- API 호환성: 현재 임의 데이터 구조가 향후 Open Weather Map 등 API 응답 구조와  
  유사하게 설계  
### 리스크 관리  
  
- Mock 데이터 fallback: DB 조회 실패 시 임시로 Mock 데이터 사용 (옵션)  
- 마이그레이션 롤백: 문제 발생 시 supabase:reset 또는 마이그레이션 되돌리기  
- 점진적 배포: 로컬 테스트 완료 후 프로덕션 배포 (Vercel)  
  
 ---## 7. 체크리스트 형태 요약  
  
### Phase 1: DB 준비  
  
[ ] 작업 1: monthly_weather 테이블 마이그레이션 생성  
[ ] 작업 2: RLS 정책 설정 (읽기 공개)  
[ ] 작업 3: 15개 도시 × 12개월 임의 데이터 시드  
[ ] 작업 4: TypeScript 타입 자동 생성  
  
### Phase 2: 백엔드 로직  
  
- 작업 5: getMonthlyWeather() 쿼리 함수 작성  
  
### Phase 3: UI 통합  
  
- 작업 6: WeatherChart 컴포넌트 DB 연동  
- 작업 7: 도시 상세 페이지 통합  
  
### Phase 4: 테스트 & 정리  
  
- 작업 8: 로컬 테스트 (15개 도시 확인)  
- 작업 9: 코드 정리 및 주석 추가  
  
 ---핵심 파일 경로  
┌──────────────────────┬────────────────────────────────────────────────────────────┐  
│         파일         │                            경로                            │  
├──────────────────────┼────────────────────────────────────────────────────────────┤  
│ 마이그레이션 (신규)  │ supabase/migrations/{timestamp}_create_monthly_weather.sql │  
├──────────────────────┼────────────────────────────────────────────────────────────┤  
│ 시드 데이터          │ supabase/seed.sql 또는 별도 마이그레이션                   │  
├──────────────────────┼────────────────────────────────────────────────────────────┤  
│ 타입 정의            │ types/database.types.ts (자동 생성)                        │  
├──────────────────────┼────────────────────────────────────────────────────────────┤  
│ 쿼리 함수 (신규)     │ utils/supabase/queries/weather.ts                          │  
├──────────────────────┼────────────────────────────────────────────────────────────┤  
│ WeatherChart         │ components/city/WeatherChart.tsx                           │  
├──────────────────────┼────────────────────────────────────────────────────────────┤  
│ 도시 상세 페이지     │ app/city/[citySlug]/page.tsx                               │  
├──────────────────────┼────────────────────────────────────────────────────────────┤  
│ Mock 데이터 (레거시) │ lib/mock-data.ts                                           │  
└──────────────────────┴────────────────────────────────────────────────────────────┘  
 ---### 예상 총 작업 시간  
  
- Phase 1 (DB 준비): 3.75시간  
- Phase 2 (백엔드): 1.5시간  
- Phase 3 (UI 통합): 3.5시간  
- Phase 4 (테스트 & 정리): 1.5시간  
- 총계: 약 10.25시간 (1.5일 분량)  
  
 ---### 향후 확장 계획 (참고)  
  
본 작업 범위 외이지만, 날씨 API 연동 시 고려사항:  
- Open Weather Map API: 현재 날씨 + 5일 예보 제공  
- 기상청 API: 한국 지역 상세 데이터  
- 자동 갱신 로직: Cron Job 또는 Supabase Edge Function으로 일 1회 갱신  
- 히스토리 저장: 월별 데이터의 버전 관리 (연도별 기록)

---


🎊 최종 요약

  월별 날씨 정보 Supabase 저장 및 그래프 표시 기능이 성공적으로 구현되었습니다!

  📊 구현 결과

  1. 데이터베이스
    - monthly_weather 테이블 생성 및 마이그레이션 완료
    - 15개 도시 × 12개월 = 180개 레코드 저장 완료
    - RLS 정책으로 보안 설정 완료
  2. 백엔드 로직
    - 날씨 데이터 조회 함수 구현 (utils/supabase/queries/weather.ts)
    - 도시 상세 조회 시 자동으로 날씨 데이터 포함
  3. 프론트엔드 통합
    - 기존 WeatherChart 컴포넌트는 변경 없음
    - DB 데이터가 자동으로 그래프에 표시됨
  4. 테스트 검증
    - ✅ 로컬 Supabase에 데이터 정상 저장
    - ✅ API 조회 정상 작동
    - ✅ 개발 서버 정상 실행

  🔧 기술적 성과

  - Mock 데이터에서 실제 DB 기반 시스템으로 전환
  - 타입 안정성 유지 (TypeScript 자동 생성)
  - 확장 가능한 아키텍처 구축
  - 최소 변경으로 최대 효과 달성