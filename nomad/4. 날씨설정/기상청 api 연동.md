## 기능 분석 요약
기상청 ASOS와 에어코리아 API를 연동해 monthly_weather 테이블을 매월 자동 업데이트합니다. 월별 평균기온, 강수량, AQI 데이터를 실시간 수집하며, Vercel Cron Jobs로 매월 1일 실행됩니다.

## 작업 분해 개요
총 12개 태스크로 30시간 분해되었으며, API 연동부터 크론잡 배포까지 순차 진행합니다. 병렬 처리로 효율화 가능합니다.

| Phase | 주요 태스크 | 예상 시간 | 선행 작업 |
|-------|-------------|-----------|-----------|
| Phase 1: 준비 | API 키 발급, DB 마이그레이션 | 3시간 | 없음 |
| Phase 2: API 연동 | 기상청/에어코리아 클라이언트 | 5시간 | Phase 1 (병렬) |
| Phase 3: 데이터 처리 | 계산 로직, Supabase 저장 | 4시간 | Phase 2 |
| Phase 4: 자동화 | 크론잡, 수동 동기화 API | 6시간 | Phase 3 |
| Phase 5: 검증/배포 | 에러 처리, 테스트, 프로덕션 | 7시간 | Phase 4 |

## 병렬 처리 및 우선순위
- **병렬 가능**: 작업 1(API 키)+작업 2(DB), 작업 3(기상청)+작업 4(에어코리아).
- **우선순위**: 작업 1(API 키, 승인 대기 리스크) → 작업 3(기상청, 핵심 데이터) → 작업 7(크론잡, 통합 지점).

## 주요 위험 요소 관리
| 리스크              | 영향도 | 대응 방안         |
| ---------------- | --- | ------------- |
| API 트래픽 제한       | 높음  | 재시도 간격 조정, 캐싱 |
| Vercel 타임아웃(10초) | 높음  | 도시별 분산 처리     |
| 관측소 코드 불일치       | 중간  | 매핑 테이블, 폴백 로직 |

## 마일스톤 체크포인트
| 마일스톤 | 확인 사항 | 실패 대응 |
|----------|-----------|-----------|
| M1: API 연동 | 테스트 호출 성공 | 대체 API 검토 |
| M2: 데이터 처리 | 로컬 DB 저장 확인 | RLS 정책 점검 |
| M3: 크론잡 구축 | 로컬 테스트 성공 | 타임아웃 확인 |
| M4: 배포 | 첫 크론잡 실행 | 롤백 및 로그 분석 |

## 개발 원칙 및 파일 구조
서버사이드 타입 안전성, 재시도 로직 필수, 환경변수 관리 준수. 주요 신규 파일: lib/weather-api.ts, app/api/cron/update-monthly-weather/route.ts, vercel.json.

## 체크리스트 (실행 순서)
### Phase 1 (3h)
- [ ] 작업 1: API 키 발급 및 .env 설정
- [ ] 작업 2: weather_station_id 마이그레이션, 매핑 데이터 입력

### Phase 2 (5h, 병렬)
- [ ] 작업 3: fetchDailyWeatherData() 서울 1월 데이터 조회 성공
- [ ] 작업 4: fetchMonthlyAQI() PM2.5/PM10 평균 계산

### Phase 3 (4h)
- [ ] 작업 5: calculateMonthlyAverage() 단위 테스트 통과
- [ ] 작업 6: upsertMonthlyWeather() 트랜잭션 처리

### Phase 4 (6h)
- [ ] 작업 7: /api/cron/update-monthly-weather 전달 데이터 수집
- [ ] 작업 8: vercel.json "0 3 1 * *" 크론 스케줄 등록
- [ ] 작업 9: /api/admin/weather-sync 관리자 인증 포함

### Phase 5 (7h)
- [ ] 작업 10: Exponential backoff 재시도(3회), Sentry 로깅
- [ ] 작업 11: 서울 2026년 1월 전체 플로우 테스트
- [ ] 작업 12: 프로덕션 배포, 첫 크론잡 로그 확인

## 모니터링 지표
- 크론잡 성공률 95% 이상 목표.
- API 응답 5초 이내.
- monthly_weather row count 주간 추이 확인.

주요 기술 결정
  - ✅ ASOS 일자료 API 사용 (월별 통계 API 없음)
  - ✅ 일별 데이터를 수집하여 월별 평균 계산
  - ✅ 기존 UI 컴포넌트 재사용 (변경 불필요)
  - ✅ Vercel Cron Jobs로 매월 1일 자동 실행
  - ✅ 수동 동기화 API 제공 (디버깅용)
