# 작업공간 기능 고도화: 글과 이미지 업로드 기능

## 1. 기능 분석

### 문제와 목표

현재 작업공간 리뷰는 텍스트 기반의 제목과 내용만 지원합니다. 사용자가 작업공간 방문 후 경험을 더 풍부하게 공유할 수 없고, 다른 사용자들이 시각적 정보 없이 의사결정을 해야 합니다.

목표: 사용자가 작업공간 리뷰에 이미지와 추가 텍스트 콘텐츠를 업로드하여 더 풍부한 경험을 공유할 수 있도록 함.

### 범위

#### 포함되는 것
- 리뷰 작성 시 여러 이미지 업로드 (최대 5개)
- 각 이미지에 캡션 추가 가능
- 이미지 저장소: Supabase Storage
- 이미지 최적화 (리사이징, 압축)
- 리뷰 상세 페이지에서 이미지 갤러리 표시
- 리뷰 수정 시 이미지 추가/삭제
- 이미지 업로드 진행 상황 표시 (UX 개선)

#### 제외되는 것
- 영상(동영상) 업로드
- 실시간 이미지 프리뷰 (파일 선택 후 미리보기만)
- 이미지 필터/편집 기능 (Unsplash처럼)
- 소셜 미디어 공유 기능
- AI 기반 이미지 분석/태깅
- 사용자 프로필 배경 이미지 등 별도 기능

### 주요 사용자 시나리오

#### 시나리오 1: 일반 사용자의 리뷰 작성
1. 도시 페이지 → 작업공간 상세 페이지
2. "리뷰 작성" 버튼 클릭
3. 제목, 평점, 내용 입력
4. "이미지 추가" 버튼으로 2~3개 이미지 선택
5. 각 이미지에 캡션 추가 (선택사항)
6. "리뷰 제출" 클릭
7. 리뷰 목록에 자신의 리뷰가 이미지와 함께 표시됨

#### 시나리오 2: 기존 리뷰 수정
1. 내가 작성한 리뷰의 "수정" 버튼 클릭
2. 기존 이미지 보기 및 삭제 가능
3. 새로운 이미지 추가
4. "저장" 클릭

#### 시나리오 3: 리뷰 조회 (읽기)
1. 작업공간 페이지에서 리뷰 목록 스크롤
2. 리뷰 이미지 갤러리 표시 (썸네일)
3. 이미지 클릭 시 풀사이즈 모달로 보기
4. 갤러리 슬라이드 네비게이션

### 기능 요구사항

#### UI/화면 요소
1. **리뷰 작성 폼 (WorkspaceReviewForm.tsx)**
   - 기존: 제목, 내용, 평점, 방문일, 추천 여부 입력 필드
   - 추가 필요:
     - 파일 입력 영역 (Drag & Drop 지원)
     - 선택된 이미지 미리보기
     - 각 이미지별 캡션 입력 필드
     - 이미지 순서 변경 (드래그)
     - 이미지 삭제 버튼
     - 업로드 진행률 표시 (파일명 기준)

2. **리뷰 상세/목록 표시**
   - 리뷰 목록에서 이미지 썸네일 그리드 (최대 3개 표시, "더보기" 버튼)
   - 리뷰 상세 보기 → 이미지 갤러리
   - 모달 갤러리 (풀스크린, 슬라이드, 캡션 표시)

3. **이미지 관리 UI**
   - 업로드 진행 상황 표시
   - 오류 메시지 (파일 크기, 형식 등)
   - 업로드 취소 버튼
   - 로딩 상태 표시

#### 기술적 요구사항
1. **데이터베이스 확장**
   - workspace_reviews 테이블: has_images BOOLEAN 필드 추가[2]
   - 새 테이블 workspace_review_images:
     | 필드          | 타입              | 설명                  ||
     |---------------|-------------------|-----------------------|
     | id           | UUID (PK)        |                       |
     | review_id    | UUID (FK)        | workspace_reviews 참조 |
     | image_url    | TEXT             | Supabase Storage URL |
     | caption      | VARCHAR(500)     | 각 이미지 캡션       |
     | display_order| INTEGER          | 정렬 순서            |
     | file_size    | INTEGER          | 파일 크기 (통계용)   |
     | uploaded_at  | TIMESTAMPTZ      |                       |
   - 인덱스: idx_review_images_review_id, idx_review_images_display_order
   - RLS 정책 적용

2. **Supabase Storage 설정**
   - 새 버킷: workspace-review-images
   - 경로 구조: {workspace_id}/{review_id}/{timestamp}-{filename}
   - 공개 읽기 권한, 소유자만 쓰기/삭제 권한
   - 자동 삭제 정책 (리뷰 삭제 시)

3. **API 엔드포인트**
   - POST /api/workspaces/[id]/reviews 확장 (multipart/form-data, 최대 5개 이미지, 각 5MB)
   - PUT /api/workspaces/[id]/reviews/[reviewId] 확장
   - DELETE /api/workspaces/[id]/reviews/[reviewId]/images/[imageId]
   - POST /api/workspaces/[id]/reviews/upload-image (선택)

4. **이미지 최적화**
   - 라이브러리: sharp (Node.js)
   - 최대 5MB, JPEG/PNG/WebP 지원
   - 리사이징: 원본 2000px, 썸네일 300px
   - 압축: 80% 품질

5. **Server Actions**
   - submitWorkspaceReview 확장
   - deleteWorkspaceReviewImage 추가
   - reorderWorkspaceReviewImages 추가

6. **클라이언트 상태 관리**
   - React Hook Form
   - 이미지 상태: pending, uploading, success, error

#### 외부 연동
- Supabase Storage API
- sharp 라이브러리
- react-dropzone
- react-medium-image-zoom (선택)

## 2. 작업 분해

### Phase 1: 데이터베이스 및 저장소 구축

#### Task 1-1: 데이터베이스 마이그레이션 작성
- 예상 시간: 1시간
- 완료 조건: npm run supabase:reset 성공, 타입 생성 확인

#### Task 1-2: Supabase Storage 버킷 설정
- 예상 시간: 1시간
- 완료 조건: 버킷 생성, 권한 확인

#### Task 1-3: RLS 정책 적용
- 예상 시간: 1시간
- 완료 조건: SELECT/INSERT/DELETE 정책 테스트

### Phase 2: 백엔드 API 개발

#### Task 2-1: 이미지 최적화 라이브러리 설정 (sharp)
- 예상 시간: 1시간
- 완료 조건: lib/image-utils.ts 테스트

#### Task 2-2: 리뷰 생성 API 확장
- 예상 시간: 2시간
- 완료 조건: multipart 업로드, Postman 테스트

#### Task 2-3: 리뷰 수정 API 확장
- 예상 시간: 2시간
- 완료 조건: 트랜잭션 처리 테스트

#### Task 2-4: 이미지 삭제 API
- 예상 시간: 1시간

#### Task 2-5: 리뷰 조회 API 확장
- 예상 시간: 1시간

#### Task 2-6: Server Actions 작성/확장
- 예상 시간: 2시간

### Phase 3: 프론트엔드 컴포넌트 개발

#### Task 3-1: 이미지 업로드 Input 컴포넌트 생성
- 예상 시간: 2시간

#### Task 3-2: 이미지 캡션 입력 필드
- 예상 시간: 1시간

#### Task 3-3: 리뷰 작성 폼 확장
- 예상 시간: 2시간

#### Task 3-4: 리뷰 목록 컴포넌트 확장
- 예상 시간: 2시간

#### Task 3-5: 이미지 갤러리 모달 컴포넌트
- 예상 시간: 2시간

#### Task 3-6: 리뷰 수정 폼 확장
- 예상 시간: 2시간

### Phase 4: 통합 테스트 및 최적화

#### Task 4-1: E2E 사용자 시나리오 테스트
- 예상 시간: 2시간

#### Task 4-2: 성능 최적화
- 예상 시간: 2시간

#### Task 4-3: 오류 처리 및 재시도 로직
- 예상 시간: 1시간

#### Task 4-4: 보안 검토
- 예상 시간: 1시간

#### Task 4-5: 접근성 (a11y) 검수
- 예상 시간: 1시간

## 3. 실행 관점 정리

### 병렬 처리 가능 여부
- 병렬: Task 1-1/1-2, Task 2-1, Task 3-1/3-2, Task 4-2/4-3
- 순차: Phase 1 → 2 → 3 → 4

### 우선순위 작업
1. Task 1-1~1-3 (기반)
2. Task 2-2/2-3 (핵심 API)
3. Task 3-3/3-4 (UI)
4. Task 4-4 (보안)

### 테스트 계획
- 기능 테스트 (단위, API)
- 통합 테스트 (시나리오 1~3)
- 성능/보안/접근성/호환성 테스트

## 4. 산출물 및 체크포인트

### 마일스톤
- Milestone 1: Phase 1 (1일)
- Milestone 2: Phase 2 (3일)
- Milestone 3: Phase 3 (3일)
- Milestone 4: Phase 4 (2일)

### 체크포인트 (Phase별 상세 확인 사항)
Phase 1 완료 후: 마이그레이션/테이블/RLS/타입 확인

Phase 2 완료 후: sharp/API/Server Actions 테스트

Phase 3 완료 후: UI/폼/모달 작동 확인

Phase 4 완료 후: E2E/성능/보안/a11y 통과

### 문서화 항목
1. Database Schema
2. API Documentation
3. Component Documentation
4. Type Definitions
5. Environment Variables

### 모니터링 항목
- 기능/성능/사용자/보안/비용 지표

## 5. 추가 원칙/조건

### 작업 분해 원칙
- 각 Task 1~4시간
- 기반 → API → UI → 테스트 순

### 난이도별 우선순위
1. 높음: Task 1-1, 2-2, 4-4
2. 중간: Task 3-3~3-5
3. 낮음: Task 3-1/3-2, 4-5

### 리스크 관리
- 고위험: Storage 권한, 대용량 파일, 보안
- 개발 환경: Node.js 18+, Supabase

## 6. 출력 형식: 작업 체크리스트

### Phase 1: 데이터베이스 & 저장소 구축
- [ ] Task 1-1: DB 마이그레이션 작성
  - [ ] workspace_reviews.has_images 추가
  - [ ] workspace_review_images 생성
  - [ ] 인덱스 생성
  - [ ] npm run supabase:reset 성공
  - [ ] 타입 생성 완료
- [ ] Task 1-2: Supabase Storage 버킷 설정
- [ ] Task 1-3: RLS 정책 적용

### Phase 2: 백엔드 API 개발
- [ ] Task 2-1: Sharp 라이브러리 설정
- [ ] Task 2-2: 리뷰 생성 API 확장
- [ ] Task 2-3: 리뷰 수정 API 확장
- [ ] Task 2-4: 이미지 삭제 API
- [ ] Task 2-5: 리뷰 조회 API 확장
- [ ] Task 2-6: Server Actions 작성

### Phase 3: 프론트엔드 컴포넌트 개발
- [ ] Task 3-1: ImageUploadInput 컴포넌트
- [ ] Task 3-2: ImageCaptionInput 컴포넌트
- [ ] Task 3-3: WorkspaceReviewForm 확장
- [ ] Task 3-4: 리뷰 목록 컴포넌트
- [ ] Task 3-5: ImageGalleryModal 컴포넌트
- [ ] Task 3-6: 리뷰 수정 폼 확장

### Phase 4: 테스트 & 배포
- [ ] Task 4-1: E2E 테스트
- [ ] Task 4-2: 성능 최적화
- [ ] Task 4-3: 오류 처리
- [ ] Task 4-4: 보안 검수
- [ ] Task 4-5: 접근성 검수

## 최종 요약
이 계획은 작업공간 리뷰에 이미지 업로드 기능을 추가하기 위한 전체 로드맵입니다. 총 예상 기간 약 2주, 핵심 마일스톤 DB → API → UI → 테스트, 주요 리스크 보안/성능/권한.[3][1]

출처
[1] 다음글을 마크다운으로 정리
작업공간 기능 고도화: 글과 이미지 업로드 기능

 1. 기능 분석

 문제와 목표

 현재 작업공간 리뷰는 텍스트 기반의 제목과 내용만 지원합니다. 사용자가 작업공간 방문 후 경험을 더
 풍부하게 공유할 수 없고, 다른 사용자들이 시각적 정보 없이 의사결정을 해야 합니다.

 목표: 사용자가 작업공간 리뷰에 이미지와 추가 텍스트 콘텐츠를 업로드하여 더 풍부한 경험을 공유할 수
 있도록 함.

 범위

 포함되는 것:...

...대비
   □ 화면 확대 테스트 (200%)
   □ axe DevTools 검사 통과

 ---
 최종 요약

 이 계획은 작업공간 리뷰에 이미지 업로드 기능을 추가하기 위한 전체적인 로드맵입니다.

 - 총 예상 기간: 약 2주 (병렬 처리 고려)
 - 핵심 마일스톤: DB → API → UI → 테스트
 - 필수 완료 항목: Phase 1, 2, 3, 4-4 (보안)
 - 위험 요소: 보안(파일 업로드), 성능(이미지 최적화), 권한 관리 https://www.perplexity.ai/search/1a654217-a25c-4203-8ac8-342781ee6478
[2] workspace_reviews에 workspace_review_images 테이블의 관계설정을 정리한 글이다.
   - workspace_reviews 테이블: has_images BOOLEAN 필드 추가
   - 새 테이블 workspace_review_images:
   - id: UUID (PK)
 - review_id: UUID (FK → workspace_reviews)
 - image_url: TEXT (Supabase Storag...

... caption: VARCHAR(500) - 각 이미지 캡션
 - display_order: INTEGER - 정렬 순서
 - file_size: INTEGER - 파일 크기 (통계용)
 - uploaded_at: TIMESTAMPTZ
   - 인덱스: idx_review_images_review_id, idx_review_images_display_order
   - RLS 정책 적용

이중에 has_image를 사용하는것이 적절한지 확인해라 https://www.perplexity.ai/search/894f6728-a943-44ff-b5e2-3754d4cca86a
[3] 마크다운으로 정리
 1. 기능 분석

  문제와 목표

  - 문제: 현재 도시별 작업공간 정보가 텍스트 기반으로만 제공되어 시각적 정보 부족
  - 목표: 사용자가 작업공간 사진을 업로드하여 다른 사용자에게 실제 공간 정보를 제공할 수 있도록 함

  범위

  포함되는 것:
  - 작업공간 정보 CRUD (생성, 조회, 수정, 삭제)
  - 이미지 파일 업로드 (Supabase Storage)
  - 이미지 미리보기 및 삭제
  - 작업공간...

...rkspaceForm.tsx 구현 (Admin 전용)
    - 생성/수정 폼
    - 삭제 확인 모달
    - 검수 조건: 생성/수정 성공, 이미지 교체 확인

  Phase 5: 테스트 및 배포

  - Task 16: 통합 테스트 및 UX 개선
    - E2E 시나리오 테스트
    - 권한 테스트
    - 성능 최적화
    - 접근성 개선
    - 검수 조건: 테스트 체크리스트 완료, Lighthouse 점수 확인

  --- https://www.perplexity.ai/search/e9da4a92-6d14-4488-bbc3-ad982cb9fe02
