## 1. 기능 분석

### 1.1 문제와 목표

- 현재 작업공간 리뷰는 텍스트 기반의 제목과 내용만 지원하여, 사용자가 방문 경험을 충분히 공유하기 어렵고 시각적 정보 없이 의사결정을 해야 하는 문제가 있음.
- 목표: 사용자가 작업공간 리뷰에 이미지와 추가 텍스트 콘텐츠를 업로드하여 더 풍부한 경험을 공유할 수 있도록 기능을 확장함.

### 1.2 범위

**포함되는 것**

- 리뷰 작성 시 여러 이미지 업로드 (최대 5개)
- 각 이미지에 캡션 추가 가능
- 이미지 저장소: Supabase Storage
- 이미지 최적화 (리사이징, 압축)
- 리뷰 상세 페이지에서 이미지 갤러리 표시
- 리뷰 수정 시 이미지 추가/삭제
- 이미지 업로드 진행 상황 표시 (UX 개선)

**제외되는 것**

- 영상(동영상) 업로드
- 실시간 이미지 프리뷰 (파일 선택 후 미리보기만)
- 이미지 필터/편집 기능
- 소셜 미디어 공유 기능
- AI 기반 이미지 분석/태깅
- 사용자 프로필 배경 이미지 등 별도 기능

### 1.3 주요 사용자 시나리오

**시나리오 1: 일반 사용자의 리뷰 작성**

1. 도시 페이지 → 작업공간 상세 페이지 이동
2. "리뷰 작성" 버튼 클릭
3. 제목, 평점, 내용 입력
4. "이미지 추가" 버튼으로 2~3개 이미지 선택
5. 각 이미지에 캡션 추가(선택사항)
6. "리뷰 제출" 클릭
7. 리뷰 목록에 이미지와 함께 리뷰 표시

**시나리오 2: 기존 리뷰 수정**

1. 내가 작성한 리뷰의 "수정" 버튼 클릭
2. 기존 이미지 확인 및 삭제 가능
3. 새로운 이미지 추가
4. "저장" 클릭

**시나리오 3: 리뷰 조회(읽기)**

1. 작업공간 페이지에서 리뷰 목록 스크롤
2. 리뷰 이미지 갤러리(썸네일) 표시
3. 이미지 클릭 시 풀사이즈 모달로 보기
4. 갤러리 슬라이드 네비게이션 사용

### 1.4 기능 요구사항

#### UI/화면 요소

1. **리뷰 작성 폼 (WorkspaceReviewForm.tsx)**  
   - 기존: 제목, 내용, 평점, 방문일, 추천 여부 입력 필드  
   - 추가:
     - 파일 입력 영역 (Drag & Drop 지원)
     - 선택된 이미지 미리보기
     - 각 이미지별 캡션 입력 필드
     - 이미지 순서 변경(드래그)
     - 이미지 삭제 버튼
     - 업로드 진행률 표시(파일명 기준)

2. **리뷰 상세/목록 표시**
   - 리뷰 목록에서 이미지 썸네일 그리드 (최대 3개, "더보기" 버튼)
   - 리뷰 상세 보기 시 이미지 갤러리
   - 모달 갤러리: 풀스크린, 슬라이드, 캡션 표시

3. **이미지 관리 UI**
   - 업로드 진행 상황 표시
   - 오류 메시지(파일 크기, 형식 등)
   - 업로드 취소 버튼
   - 로딩 상태 표시

#### 기술적 요구사항

1. **데이터베이스 확장**

- `workspace_reviews` 테이블
  - `has_images` BOOLEAN 필드 추가
- 새 테이블 `workspace_review_images`
  - `id`: UUID (PK)
  - `review_id`: UUID (FK → `workspace_reviews`)
  - `image_url`: TEXT (Supabase Storage URL)
  - `caption`: VARCHAR(500)
  - `display_order`: INTEGER
  - `file_size`: INTEGER
  - `uploaded_at`: TIMESTAMPTZ
- 인덱스
  - `idx_review_images_review_id`
  - `idx_review_images_display_order`
- RLS 정책 적용

2. **Supabase Storage 설정**

- 새 버킷: `workspace-review-images`
- 경로 구조: `{workspace_id}/{review_id}/{timestamp}-{filename}`
- 공개 읽기 권한, 소유자만 쓰기/삭제 권한
- 리뷰 삭제 시 자동 삭제 정책

3. **API 엔드포인트**

- 기존 `POST /api/workspaces/[id]/reviews` 확장
  - `multipart/form-data` 지원
  - 최대 5개 이미지, 각 최대 5MB
  - 동시 업로드 처리
- `PUT /api/workspaces/[id]/reviews/[reviewId]` 확장
  - 이미지 추가/삭제 지원
- 새 엔드포인트
  - `DELETE /api/workspaces/[id]/reviews/[reviewId]/images/[imageId]`
    - 개별 이미지 삭제
  - 선택: `POST /api/workspaces/[id]/reviews/upload-image`
    - 별도 이미지 업로드(프리사인드 URL 반환)

4. **이미지 최적화**

- 라이브러리: `sharp` (Node.js 이미지 처리)
- 최대 크기: 5MB
- 지원 형식: JPEG, PNG, WebP
- 자동 리사이징
  - 원본: 최대 2000px
  - 썸네일: 300px
- 압축: JPEG/WebP 80% 품질

5. **Server Actions**

- `submitWorkspaceReview(workspaceId, reviewData, images[])` 확장
- `deleteWorkspaceReviewImage(imageId, userId)` 추가
- `reorderWorkspaceReviewImages(reviewId, imageIds[])` 추가

6. **클라이언트 상태 관리**

- React Hook Form 또는 기존 form 상태 유지
- 이미지 업로드 상태: `pending`, `uploading`, `success`, `error`
- 각 이미지별 진행률 추적

#### 외부 연동

- Supabase Storage API
- `sharp` 라이브러리
- `react-dropzone` 또는 기본 HTML5 input (Drag & Drop)
- 선택: `react-medium-image-zoom` (이미지 줌)

---

## 2. 작업 분해

### Phase 1: 데이터베이스 및 저장소 구축

**Task 1-1: 데이터베이스 마이그레이션 작성**

- 설명: `workspace_reviews`에 `has_images` 필드 추가, `workspace_review_images` 테이블 생성
- 예상 시간: 1시간
- 선행 작업: 없음
- 완료 조건:
  - `npm run supabase:migration:new`로 마이그레이션 파일 생성
  - SQL 작성 후 `npm run supabase:reset` 성공
  - `npm run supabase:gen:types` 후 타입 생성 확인
- 위험 요소:
  - 기존 데이터와의 호환성(NULL 처리)
  - RLS 정책 누락

**Task 1-2: Supabase Storage 버킷 설정**

- 설명: `workspace-review-images` 버킷 생성, 권한 설정, 자동 정리 규칙
- 예상 시간: 1시간
- 선행 작업: Task 1-1
- 완료 조건:
  - 버킷 생성 및 공개 읽기 권한 확인
  - 경로 권한: 소유자만 쓰기/삭제
  - 자동 만료 정책 문서화
- 위험 요소:
  - 과도하게 열리거나 닫힌 권한 정책
  - 저장소 비용 증가

**Task 1-3: RLS 정책 적용**

- 설명: `workspace_review_images` 테이블에 RLS 정책 적용
- 예상 시간: 1시간
- 선행 작업: Task 1-1, Task 1-2
- 완료 조건:
  - SELECT: 모든 사용자 가능
  - INSERT: 인증된 사용자 가능
  - DELETE: 자신의 이미지만 삭제 가능
  - Supabase Studio에서 로컬 테스트
- 위험 요소:
  - 권한 누락으로 인한 기능 장애
  - 다른 사용자 데이터 접근 가능 등 보안 문제

---

### Phase 2: 백엔드 API 개발

**Task 2-1: 이미지 최적화 라이브러리 설정(sharp)**

- 설명: sharp 설치, 이미지 리사이징/압축 유틸 함수 작성
- 예상 시간: 1시간
- 선행 작업: 없음
- 완료 조건:
  - `npm install sharp`
  - `lib/image-utils.ts` 생성
    - `resizeImage(buffer, maxWidth)`
    - `compressImage(buffer, quality)`
    - `validateImage(file)`
  - 로컬 테스트(테스트 이미지 업로드)
- 위험 요소:
  - sharp 빌드 오류(바이너리 호환성)
  - 큰 이미지로 인한 메모리 부족

**Task 2-2: 리뷰 생성 API 확장(이미지 업로드)**

- 설명: `POST /api/workspaces/[id]/reviews`에 `multipart/form-data` 지원
- 예상 시간: 2시간
- 선행 작업: Task 1-1, 1-2, 1-3, 2-1
- 완료 조건:
  - 요청 형식: `multipart/form-data` (텍스트 필드 + 파일)
  - 최대 5개 이미지, 각 5MB 검증
  - Supabase Storage 업로드(`{workspace_id}/{review_id}/...`)
  - `workspace_review_images` 레코드 생성
  - `workspace_reviews.has_images` 업데이트
  - 파일 크기/형식/업로드 실패 오류 처리
  - curl/Postman 로컬 테스트
- 위험 요소:
  - 큰 파일로 인한 네트워크 타임아웃
  - 일부 이미지 업로드 실패 시 부분 실패 처리
  - Storage 연결 오류

**Task 2-3: 리뷰 수정 API 확장(이미지 추가/삭제)**

- 설명: `PUT /api/workspaces/[id]/reviews/[reviewId]` 확장
- 예상 시간: 2시간
- 선행 작업: Task 2-2
- 완료 조건:
  - 요청: 삭제할 이미지 ID 배열 + 새 이미지 파일
  - 기존 이미지 조회 후 삭제 대상 필터링, Supabase에서 삭제
  - 새 이미지 업로드
  - `display_order` 재정렬
  - 트랜잭션 처리(부분 실패 방지)
  - 이미지 추가/삭제/혼합 테스트
- 위험 요소:
  - 트랜잭션 실패로 DB와 Storage 불일치
  - 고아 이미지 파일 남는 문제

**Task 2-4: 이미지 삭제 API**

- 설명: `DELETE /api/workspaces/[id]/reviews/[reviewId]/images/[imageId]`
- 예상 시간: 1시간
- 선행 작업: Task 1-1, 1-3
- 완료 조건:
  - 이미지 소유자 검증
  - DB 레코드 삭제
  - Supabase Storage 파일 삭제
  - 이미 삭제된 파일 처리
  - 성공 응답 `{ success: true }`
- 위험 요소:
  - 권한 검증 누락
  - Storage 삭제 실패

**Task 2-5: 리뷰 조회 API 확장(이미지 포함)**

- 설명: `GET /api/workspaces/[id]/reviews` 응답에 이미지 데이터 포함
- 예상 시간: 1시간
- 선행 작업: Task 1-1
- 완료 조건:
  - 리뷰 조회 시 `images[]` 필드 추가
  - 이미지 배열 구조: `{ id, imageUrl, caption, displayOrder }`
  - `displayOrder` 기준 정렬
  - N+1 방지 등 성능 최적화
  - 이미지 없는 리뷰·여러 이미지 리뷰 테스트
- 위험 요소:
  - JOIN 증가로 인한 쿼리 성능 저하

**Task 2-6: Server Actions 작성/확장**

- 설명: `app/actions/workspaces.ts` 확장
- 예상 시간: 2시간
- 선행 작업: Task 2-2, 2-3, 2-4
- 완료 조건:
  - 함수
    - `submitWorkspaceReview(workspaceId, reviewData, images[])`
    - `updateWorkspaceReview(reviewId, reviewData, imagesToDelete[], newImages[])`
    - `deleteWorkspaceReviewImage(imageId, userId)`
  - 클라이언트에서 직접 호출 가능
  - 권한 검증 포함
  - 오류 처리 및 메시지
  - 타입 안전성 확보
- 위험 요소:
  - FormData vs 객체 타입 미스매치

---

### Phase 3: 프론트엔드 컴포넌트 개발

**Task 3-1: 이미지 업로드 Input 컴포넌트**

- 설명: `components/workspace/ImageUploadInput.tsx` 생성
- 예상 시간: 2시간
- 선행 작업: Task 2-1
- 완료 조건:
  - Drag & Drop 지원
  - 클릭 → 파일 선택
  - 선택 파일 썸네일 미리보기
  - 형식/크기 실시간 검증
  - 파일 제거 버튼
  - 오류 메시지 표시
  - ARIA 라벨 등 접근성
  - 기존 Shadcn 패턴 스타일
- 위험 요소:
  - Drag & Drop 브라우저 호환성
  - 대용량 파일 메모리 사용

**Task 3-2: 이미지 캡션 입력 필드**

- 설명: `components/workspace/ImageCaptionInput.tsx` 생성
- 예상 시간: 1시간
- 선행 작업: 없음
- 완료 조건:
  - 각 이미지별 캡션 입력 필드
  - 최대 500자, 실시간 카운팅
  - 선택사항 표시
  - 상태 관리(자동 저장) 연동
- 위험 요소:
  - 부모 컴포넌트와 상태 동기화

**Task 3-3: 리뷰 작성 폼 확장 (WorkspaceReviewForm.tsx)**

- 설명: 기존 폼에 이미지 업로드 섹션 추가
- 예상 시간: 2시간
- 선행 작업: Task 3-1, 3-2, 2-6
- 완료 조건:
  - 폼 구조
    - 기존: 제목, 내용, 평점, 방문일, 추천 여부
    - 추가: 이미지 업로드 섹션
    - 추가: 이미지 순서 변경(드래그/화살표)
  - 폼 제출 시
    - `submitWorkspaceReview()` Server Action 호출
    - FormData로 이미지 포함
    - 스피너/진행률 표시
  - 필수 필드 검증(제목, 내용, 평점)
  - 오류 처리 및 피드백
  - 성공 후 리뷰 목록 이동 또는 새로고침
- 위험 요소:
  - 복잡한 FormData 처리
  - 네트워크 오류 후 재시도 처리

**Task 3-4: 리뷰 목록 컴포넌트 확장(이미지 표시)**

- 설명: 리뷰 목록에서 이미지 썸네일 표시
- 예상 시간: 2시간
- 선행 작업: Task 2-5
- 완료 조건:
  - 리뷰별 이미지 썸네일 그리드(최대 3개)
  - 4개 이상인 경우 "+n" 배지
  - 썸네일 클릭 → 갤러리 모달
  - 이미지 없는 리뷰: 빈 공간 또는 기본 이미지
  - 반응형 디자인, 로딩 상태 처리
- 위험 요소:
  - 많은 리뷰 썸네일 로딩 성능
  - 이미지 로드 후 레이아웃 시프트

**Task 3-5: 이미지 갤러리 모달 컴포넌트**

- 설명: `components/workspace/ImageGalleryModal.tsx` 생성
- 예상 시간: 2시간
- 선행 작업: Task 2-5
- 완료 조건:
  - 풀스크린 모달(또는 라이트박스)
  - 이전/다음·키보드 화살표 슬라이드 네비게이션
  - 이미지 캡션 표시
  - 현재 이미지 번호(예: "2 / 5")
  - 닫기 버튼(X, ESC)
  - 모바일 스와이프 지원
  - 선택: 줌 기능, 다운로드 버튼
- 위험 요소:
  - 모바일 터치 이벤트 처리
  - 키보드 네비게이션 구현

**Task 3-6: 리뷰 수정 폼 확장**

- 설명: 리뷰 수정 페이지/모달에서 이미지 관리 UI
- 예상 시간: 2시간
- 선행 작업: Task 3-3, 3-1, 3-2
- 완료 조건:
  - 기존 이미지 표시(삭제 버튼 포함)
  - 새 이미지 추가 섹션
  - 이미지 순서 변경
  - 캡션 수정
  - 제출 시 `updateWorkspaceReview()` 호출
  - 로딩 및 오류 처리
- 위험 요소:
  - 기존/신규/삭제 상태를 모두 관리하는 복잡한 상태

---

### Phase 4: 통합 테스트 및 최적화

**Task 4-1: E2E 사용자 시나리오 테스트**

- 설명: 실제 사용 흐름에서 전체 기능 테스트
- 예상 시간: 2시간
- 선행 작업: Phase 2, 3
- 완료 조건:
  - 시나리오 1: 이미지 포함 리뷰 생성
  - 시나리오 2: 리뷰 수정(이미지 추가/삭제)
  - 시나리오 3: 리뷰 보기(이미지 갤러리)
  - 로컬 및 프로덕션 환경 테스트

**Task 4-2: 성능 최적화(이미지 로딩)**

- 설명: Next.js Image, 레이지 로딩, CDN 캐싱
- 예상 시간: 2시간
- 선행 작업: Phase 3
- 완료 조건:
  - `next/image` 컴포넌트 적용
  - 썸네일 레이지 로드(Intersection Observer)
  - Supabase CDN 캐싱 설정(Cache-Control 헤더)
  - Lighthouse 점수 확인, 로딩 시간(3G) 2초 이내 목표
- 위험 요소:
  - Supabase URL이 CDN 경유하지 않을 수 있음
  - 레이지 로딩 누락 시 성능 저하

**Task 4-3: 오류 처리 및 재시도 로직**

- 설명: 네트워크 오류, 파일 삭제 실패 등 엣지 케이스 처리
- 예상 시간: 1시간
- 선행 작업: Task 2-2, 2-3, 3-3, 3-6
- 완료 조건:
  - 업로드 실패 시 재시도 UI
  - 부분 성공 알림(예: "3개 중 2개 성공")
  - 30초 이상 타임아웃 처리
  - 사용자 친화적 오류 메시지 및 해결 가이드

**Task 4-4: 보안 검토**

- 설명: 파일 업로드 보안, RLS, 권한 검증
- 예상 시간: 1시간
- 선행 작업: Phase 2, 3
- 완료 조건:
  - 파일 타입 검증(클라이언트 + 서버)
  - 파일 크기 제한(5MB)
  - SQL Injection 방지(파라미터 쿼리)
  - XSS 방지(이미지 URL 이스케이프)
  - 자신의 리뷰만 수정/삭제 가능
  - RLS 정책 재검토
  - Content-Security-Policy 등 보안 헤더 설정
- 위험 요소:
  - 악의적인 파일 업로드
  - CSRF 공격

**Task 4-5: 접근성(a11y) 검수**

- 설명: WCAG 2.1 AA 준수 확인
- 예상 시간: 1시간
- 선행 작업: Phase 3
- 완료 조건:
  - 이미지 alt 텍스트(캡션 활용)
  - 키보드 네비게이션(갤러리 모달)
  - 스크린 리더 호환성
  - 색상 대비 검수
  - 화면 확대(200%) 시 UI 유지
  - axe DevTools, 수동 검수
- 위험 요소:
  - 모달 포커스 관리
  - 이미지 로딩 중 스켈레톤 처리

---

## 3. 실행 관점 정리

### 3.1 병렬 처리 가능 여부

**병렬 처리 가능**

- Task 1-1, 1-2 (DB와 Storage 독립)
- Task 2-1 (sharp 설정)
- Task 3-1, 3-2 (컴포넌트, 백엔드 준비 후)
- Task 4-2, 4-3 (성능 최적화와 오류 처리)

**순차 처리 필요**

1. Phase 1(DB + Storage + RLS)
2. Phase 2(API)
3. Phase 3(컴포넌트)
4. Phase 4(테스트)

### 3.2 우선순위 작업

1. Task 1-1 ~ 1-3 (DB/권한 기반)
2. Task 2-2, 2-3 (핵심 API)
3. Task 3-3, 3-4 (사용자-facing 기능)
4. Task 4-4 (보안 검수)

---

## 4. 테스트 계획

### 4.1 기능 테스트(단위 테스트)

- `lib/image-utils.ts`
  - `validateImage(file)`: 형식, 크기 검증
  - `resizeImage(buffer)`: 리사이징 결과 확인
  - `compressImage(buffer)`: 파일 크기 감소 확인
- API 엔드포인트
  - `POST /api/workspaces/[id]/reviews`: 이미지 업로드 성공
  - `PUT /api/workspaces/[id]/reviews/[reviewId]`: 이미지 추가/삭제
  - `DELETE /api/workspaces/[id]/reviews/[reviewId]/images/[imageId]`: 이미지 삭제
  - `GET /api/workspaces/[id]/reviews`: 이미지 데이터 포함 확인

### 4.2 통합 테스트(사용자 흐름)

- 시나리오 1: 이미지 포함 리뷰 작성
- 시나리오 2: 리뷰 수정(이미지 추가/삭제)
- 시나리오 3: 이미지 갤러리 보기

### 4.3 성능 테스트

- 이미지 업로드: 5MB × 3개 < 10초(3G)
- 리뷰 목록 로딩: 썸네일 포함 < 2초
- 갤러리 모달 열기: 첫 이미지 < 1초
- 대용량 이미지 업로드 후 메모리 누수 없음

### 4.4 보안 테스트

- 파일 타입/크기 검증
- 권한 검증(403 처리)
- 악의적 데이터(XSS 등) 이스케이프

### 4.5 접근성 테스트

- 화면 리더(NVDA, JAWS) 테스트
- 키보드 네비게이션(Tab, ESC, 화살표)
- 색상 대비, Lighthouse/axe 검사

### 4.6 브라우저 호환성

- 대상 브라우저
  - Chrome/Edge 최신 2버전
  - Firefox 최신 2버전
  - Safari 최신 2버전(iOS 포함)
- 핵심 기능
  - Drag & Drop
  - File API
  - FormData
  - Intersection Observer(레이지 로딩)

---

## 5. 산출물 및 체크포인트

### 5.1 마일스톤

**Milestone 1: DB & 권한 (1일)**

- 마이그레이션 작성 및 적용
- Storage 버킷 설정
- RLS 정책 적용
- 타입 생성 확인

**Milestone 2: 백엔드 API (3일)**

- sharp 설정
- 리뷰 생성/수정/삭제 API
- 리뷰 조회 API 확장
- Postman 테스트

**Milestone 3: 프론트엔드 컴포넌트 (3일)**

- 이미지 업로드 Input
- 캡션 입력 필드
- 리뷰 폼 확장
- 리뷰 목록 썸네일
- 갤러리 모달
- 리뷰 수정 폼

**Milestone 4: 테스트 & 배포 (2일)**

- E2E 시나리오 테스트
- 성능 최적화
- 오류 처리
- 보안·접근성 검수

### 5.2 체크포인트

각 Phase 완료 후 체크리스트(마이그레이션, 버킷·RLS 설정, API 동작, 타입 검증, UI 렌더링, 성능/보안/접근성 결과 등) 기반으로 문제 발생 시 롤백·수정 전략 수행.

### 5.3 문서화 항목

1. Database Schema
2. API 명세
3. 컴포넌트 문서(ImageUploadInput, ImageGalleryModal, WorkspaceReviewForm 등)
4. 타입 정의(types/workspace.ts, `WorkspaceReviewImage`, 상태 타입)
5. 환경 변수(NEXT_PUBLIC_SUPABASE_* 기존 값 활용, 추가 없
