## ğŸ“Š í˜„ì¬ ìƒí™© ë¶„ì„

### ë¬¸ì œì 
- **ì´ˆê¸° ë¡œë”© ëŠë¦¼:** ë¹Œë“œ í›„, ì„œë²„ ì¬ì‹œì‘ í›„ ì²« í™”ë©´ ì´ë™ ì‹œ 1~2ì´ˆ ì´ìƒ ì§€ì—°  
- **ë‘ ë²ˆì§¸ ë°©ë¬¸ì€ ë¹ ë¦„:** ë¸Œë¼ìš°ì € ë° Router ìºì‹œë¡œ ì¸í•´ 300~500msë¡œ ë‹¨ì¶•ë¨

### ì›ì¸
1. **ë™ì  ë Œë”ë§ë§Œ ì‚¬ìš©:** ëª¨ë“  í˜ì´ì§€ê°€ ìš”ì²­ë§ˆë‹¤ DB ì¡°íšŒ  
2. **ìºì‹± ì „ëµ ë¶€ì¬:** API ë¼ìš°íŠ¸ì— `Cache-Control` ë¯¸ì„¤ì •  
3. **ì¤‘ë³µ ì¿¼ë¦¬ ì¡´ì¬:** `generateMetadata()`ì—ì„œ `getCityBySlug()` ë°˜ë³µ í˜¸ì¶œ  
4. **ì •ì  ì‚¬ì „ ë Œë”ë§ ë¯¸ì ìš©:** `generateStaticParams` ë¯¸ì‚¬ìš©  

***

## ğŸ¯ ìµœì í™” ëª©í‘œ

| ì§€í‘œ                      | í˜„ì¬     | ëª©í‘œ    | ê°œì„ ìœ¨   |
| ----------------------- | ------ | ----- | ----- |
| TimeToFirstByte (í™ˆí˜ì´ì§€)  | 800ms  | 200ms | 75% â†“ |
| TimeToFirstByte (ë„ì‹œ ìƒì„¸) | 1200ms | 300ms | 75% â†“ |
| DB ì¿¼ë¦¬ (ë„ì‹œ ìƒì„¸)           | 5íšŒ     | 1íšŒ    | 80% â†“ |

***

## ğŸ“ êµ¬í˜„ ê³„íš

### Phase 1: ì¦‰ì‹œ ì ìš© (High Impact) âš¡

#### 1.1 `generateMetadata` ì¤‘ë³µ ì¿¼ë¦¬ ì œê±°
- **ì˜ˆìƒ íš¨ê³¼:** DB ì¿¼ë¦¬ 50% ê°ì†Œ  
- **í•µì‹¬ ë³€ê²½:** `React cache()`ë¡œ ë™ì¼ ë Œë”ë§ ë‚´ ì¤‘ë³µ ì œê±°  

```tsx
import { cache } from 'react';

const getCachedCity = cache(async (slug: string) => {
  const supabase = await createClient();
  return getCityBySlug(supabase, slug);
});

export async function generateMetadata({ params }) {
  const city = await getCachedCity(params.citySlug);
  // ...
}

export default async function CityDetailPage({ params }) {
  const city = await getCachedCity(params.citySlug);
  // ...
}
```

#### 1.2 API ë¼ìš°íŠ¸ì— Cache-Control í—¤ë” ì¶”ê°€
- **ì˜ˆìƒ ê°œì„ :** ë°˜ë³µ ìš”ì²­ 80% ê°ì†Œ  
- **ì ìš© íŒŒì¼:**  
  - `app/api/cities/route.ts` (5ë¶„)
  - `app/api/cities/[slug]/route.ts` (10ë¶„)
  - `app/api/cities/[slug]/metrics/route.ts` (10ë¶„)

```ts
return NextResponse.json(result, {
  headers: {
    'Cache-Control': 'public, s-maxage=300, stale-while-revalidate=600',
  },
});
```

#### 1.3 `unstable_cache`ë¥¼ í†µí•œ ì¿¼ë¦¬ ìºì‹±
- **ì˜ˆìƒ ê°œì„ :** DB ë¶€í•˜ 70% ê°ì†Œ  
- **íŒŒì¼:** `lib/supabase-queries.ts`

```ts
import { unstable_cache } from 'next/cache';

export async function getCityBySlug(supabase, slug) {
  const getCached = unstable_cache(
    async (slug: string) => {
      const query = supabase.from("cities").select("*").eq("name", slug).single();
      const { data } = await query;
      return convertDatabaseCityToCity(data);
    },
    [`city-detail-${slug}`],
    { revalidate: 600, tags: ['cities', `city-${slug}`] }
  );
  return getCached(slug);
}
```

***

### Phase 2: ì •ì  ì‚¬ì „ ë Œë”ë§ (`generateStaticParams`)

#### 2.1 ì¸ê¸° ë„ì‹œ ì‚¬ì „ ìƒì„±
- **ì˜ˆìƒ ê°œì„ :** ìƒìœ„ 10ê°œ ë„ì‹œ TTFB 90% ê°ì†Œ (<100ms)
- **íŒŒì¼:** `app/city/[citySlug]/page.tsx`

```tsx
export async function generateStaticParams() {
  const supabase = await createClient();
  const { data } = await getCitiesList(supabase, {
    sort: 'score', limit: 10, offset: 0,
  });

  return (data || []).map((city) => ({ citySlug: city.id }));
}

export const dynamicParams = true;
export const revalidate = 3600; // 1ì‹œê°„ë§ˆë‹¤ ê°±ì‹ 
```

***

### Phase 3: ìºì‹œ ë¬´íš¨í™” ì „ëµ

#### 3.1 `Server Actions`ì—ì„œ `revalidateTag` ì¶”ê°€
- **íŒŒì¼:**  
  - `app/actions/city-reactions.ts`  
  - `app/api/cities/[slug]/reviews/route.ts`

```ts
import { revalidateTag, revalidatePath } from 'next/cache';

export async function createReview(cityId, review) {
  await supabase.from('user_reviews').insert(review);
  revalidateTag(`city-${cityId}`);
  revalidatePath(`/city/${cityId}`);
}

export async function toggleCityReaction(cityId) {
  await supabase.from('cities').update(...);
  revalidateTag(`city-${cityId}`);
  revalidateTag('cities');
}
```

***

## ğŸ› ï¸ êµ¬í˜„ ë‹¨ê³„ë³„ ì²´í¬ë¦¬ìŠ¤íŠ¸

| ë‹¨ê³„ | ë‚´ìš© | ì˜ˆìƒ ì‹œê°„ |
|------|------|-----------|
| Step 1 | React cache() ì ìš© | 30ë¶„ |
| Step 2 | API Cache-Control ì¶”ê°€ | 30ë¶„ |
| Step 3 | unstable_cache ì ìš© | 2~3ì‹œê°„ |
| Step 4 | generateStaticParams ì¶”ê°€ | 1ì‹œê°„ |
| Step 5 | ìºì‹œ ë¬´íš¨í™” ì „ëµ êµ¬í˜„ | 2ì‹œê°„ |

***

## ğŸ” ê²€ì¦ ë°©ë²•

### ì„±ëŠ¥ ì¸¡ì •
1. **Cold Start:** ì„œë²„ ì¬ì‹œì‘ í›„ ì²« ìš”ì²­ì˜ TTFB ì¸¡ì •  
2. **Warm Cache:** ë™ì¼ í˜ì´ì§€ ì¬ë°©ë¬¸ ì†ë„ í™•ì¸  
3. **ë°ì´í„° ë³€ê²½:** ìƒˆ ë¦¬ë·° ì‘ì„±â†’ ì¦‰ì‹œ ë°˜ì˜ í™•ì¸  

### DB ì¿¼ë¦¬ í™•ì¸
- Supabase Dashboard â†’ Logs â†’ Query Logs  
- ë°˜ë³µ ì¿¼ë¦¬ ì—¬ë¶€ í™•ì¸  

### ìºì‹œ íˆíŠ¸ í™•ì¸
- Chrome DevTools â†’ Network â†’ Response Headers  
- `X-Vercel-Cache: HIT` í™•ì¸  

***

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ìºì‹± ì œì™¸
- ì‚¬ìš©ìë³„ ë°ì´í„° (`my-reviews`, `my-ratings`)  
- ì‹¤ì‹œê°„ ë°ì´í„° (í˜„ì¬ ë‚ ì”¨ API)  
- ê´€ë¦¬ì/ì¸ì¦ í˜ì´ì§€  

### ë°ì´í„° ì‹ ì„ ë„ ì„¤ì •

| ë°ì´í„° ìœ í˜• | revalidate | ì´ìœ  |
|--------------|-------------|------|
| ë„ì‹œ ëª©ë¡ | 300s | ìˆœìœ„ ë³€ë™ ë¹ˆë²ˆ |
| ë„ì‹œ ìƒì„¸ | 600s | ë³€ê²½ ë“œë¬¾ |
| ë¦¬ë·° ëª©ë¡ | 300s | ì‚¬ìš©ì í™œë™ |
| ì‘ì—…ê³µê°„ | 600s | ë³€ê²½ ë¹ˆë„ ë‚®ìŒ |

***

## ğŸ“ í•µì‹¬ íŒŒì¼ ëª©ë¡

1. `lib/supabase-queries.ts` â€“ `unstable_cache` ì ìš©  
2. `app/city/[citySlug]/page.tsx` â€“ `cache()`, `generateStaticParams`  
3. `app/api/cities/route.ts` â€“ Cache-Control í—¤ë”  
4. `app/api/cities/[slug]/route.ts` â€“ Cache-Control í—¤ë”  
5. `app/actions/city-reactions.ts` â€“ `revalidateTag` / `revalidatePath`  

***

## ğŸš€ ì˜ˆìƒ ê²°ê³¼

### ê°œì„  ì „
- ì´ˆê¸° ë°©ë¬¸: ì•½ **1100ms**  
- ì¬ë°©ë¬¸: ì•½ **300ms**

### ê°œì„  í›„
- ì´ˆê¸° ë°©ë¬¸ (Phase 1): **450ms (60% â†“)**  
- ìºì‹œ íˆíŠ¸ ì‹œ: **80ms (93% â†“)**  
- ì •ì  í˜ì´ì§€ (Phase 2): **50ms (95% â†“)**  

***

## ğŸ“Œ TODO / ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Phase 1.1: React cache() ì ìš©  
- [ ] Phase 1.2: API Cache-Control í—¤ë” ì¶”ê°€  
- [ ] Phase 1.3: unstable_cache ì ìš©  
- [ ] Phase 2.1: generateStaticParams ì¶”ê°€  
- [ ] Phase 3.1: revalidate ì „ëµ êµ¬í˜„  
- [ ] ì„±ëŠ¥ ì¸¡ì • ë° ë¡œê·¸ ê²€ì¦  