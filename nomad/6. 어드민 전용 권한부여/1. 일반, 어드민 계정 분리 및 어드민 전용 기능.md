
## 1. 기능 분석

### 문제와 목표

- 문제: 현재 모든 사용자가 동일한 권한을 가지며, 도시/작업공간 관리 및 부적절한 리뷰 관리 기능이 없음  
- 목표: 역할 기반 접근 제어(RBAC)를 도입하여 일반 사용자와 관리자를 분리하고, 관리자만 콘텐츠 관리 권한을 가지도록 함

### 범위

**포함:**
- 사용자 역할(role) 관리 (user, admin)
- 어드민 전용 도시 CRUD 기능
- 어드민 전용 작업공간 CRUD 기능
- 어드민의 리뷰 숨김 처리(soft delete/flag)
- 역할 기반 라우트 보호 및 UI 분기

**제외:**
- 세밀한 권한 관리 (예: 에디터, 모더레이터 등 중간 역할)
- 사용자 초대/승인 시스템
- 감사 로그(audit log) 기능

### 주요 사용자 시나리오

1. 일반 사용자: 도시 정보 조회, 리뷰 작성/수정, 평가 등록  
2. 어드민: 도시/작업공간 추가/수정/삭제, 부적절한 리뷰 숨김 처리  
3. 권한 검증: 어드민 페이지 접근 시 일반 사용자는 403/리다이렉트

### 기능 요구사항

**UI/화면 요소:**
- 어드민 대시보드 페이지 (`/admin`)
- 어드민 도시 관리 페이지 (`/admin/cities`)
- 어드민 작업공간 관리 페이지 (`/admin/workspaces`)
- 리뷰 관리 섹션 (숨김 버튼)
- 역할 표시 UI (헤더 메뉴 등)

**기술적 요구사항:**
- `users` 테이블에 `role` 컬럼 추가 (enum: `'user'`, `'admin'`)
- Supabase RLS 정책 업데이트 (역할별 접근 제어)
- 어드민 전용 API 엔드포인트  
  - `POST/PUT/DELETE /api/admin/cities`  
  - `POST/PUT/DELETE /api/admin/workspaces`  
  - `PATCH /api/admin/reviews/:id/hide`
- 미들웨어에서 역할 검증 로직
- Server Actions에 역할 검증 추가

**외부 연동:**
- 없음 (기존 Supabase 인프라 활용)

---

## 2. 작업 분해

### Phase 1: 데이터베이스 스키마 및 권한 설정

**작업 1-1: `users` 테이블에 `role` 필드 추가**

- 설명: `users` 테이블에 `role` enum 컬럼 추가 (기본값: `'user'`)
- 예상 시간: 1시간
- 선행 작업: 없음
- 완료 조건: 마이그레이션 파일 생성, 로컬에서 적용 확인, TypeScript 타입 재생성
- 위험 요소: 기존 사용자 데이터 마이그레이션 시 기본값 설정 필요

**작업 1-2: `user_reviews` 테이블에 `hidden` 필드 추가**

- 설명: `user_reviews` 테이블에 `hidden` boolean 컬럼 추가 (기본값: `false`)
- 예상 시간: 1시간
- 선행 작업: 없음
- 완료 조건: 마이그레이션 적용, 리뷰 조회 쿼리에서 `hidden = false` 필터링
- 위험 요소: 기존 리뷰 데이터 영향 없음

**작업 1-3: Supabase RLS 정책 업데이트**

- 설명:  
  - `cities`: `INSERT/UPDATE/DELETE`는 admin만 가능  
  - `workspaces`: `INSERT/UPDATE/DELETE`는 admin만 가능  
  - `user_reviews`: `UPDATE(hidden)`는 admin만 가능
- 예상 시간: 2시간
- 선행 작업: 1-1, 1-2
- 완료 조건: RLS 정책 테스트 (일반/어드민 계정으로 각각 검증)
- 위험 요소: 잘못된 정책 설정 시 일반 사용자도 수정 가능할 수 있음

---

### Phase 2: 인증 및 역할 검증 로직

**작업 2-1: 미들웨어에 역할 검증 추가**

- 설명: `/admin/*` 경로 접근 시 `role = 'admin'` 검증, 아니면 403/리다이렉트
- 예상 시간: 2시간
- 선행 작업: 1-1
- 완료 조건: 일반 계정으로 `/admin` 접근 시 리다이렉트 확인
- 위험 요소: 세션 갱신 로직과 충돌 가능성

**작업 2-2: Server Actions에 역할 검증 헬퍼 추가**

- 설명: `lib/auth-helpers.ts`에 `requireAdmin()` 함수 추가
- 예상 시간: 1시간
- 선행 작업: 1-1
- 완료 조건: Server Action에서 호출 시 일반 사용자는 에러 반환
- 위험 요소: 없음

**작업 2-3: 사용자 프로필에 역할 표시**

- 설명: 헤더 `UserMenu`에 role 표시, 어드민인 경우 "관리자" 뱃지 추가
- 예상 시간: 1시간
- 선행 작업: 1-1
- 완료 조건: UI에서 어드민 계정으로 로그인 시 뱃지 표시
- 위험 요소: 없음

---

### Phase 3: 어드민 도시 관리 기능

**작업 3-1: 어드민 대시보드 레이아웃 생성**

- 설명: `/app/admin/layout.tsx` 및 `/app/admin/page.tsx` 생성 (대시보드 홈)
- 예상 시간: 2시간
- 선행 작업: 2-1
- 완료 조건: `/admin` 접근 시 대시보드 레이아웃 표시
- 위험 요소: 없음

**작업 3-2: 도시 목록 페이지 (`/admin/cities`)**

- 설명: 도시 목록 조회 및 수정/삭제 버튼 표시
- 예상 시간: 3시간
- 선행 작업: 3-1
- 완료 조건: 도시 목록 조회, 각 도시별 편집/삭제 버튼 동작
- 위험 요소: 페이지네이션 미구현 시 대량 데이터 성능 이슈

**작업 3-3: 도시 생성/수정 폼**

- 설명: 도시 추가/수정 폼 컴포넌트 구현 (`/admin/cities/new`, `/admin/cities/[slug]/edit`)
- 예상 시간: 4시간
- 선행 작업: 3-2
- 완료 조건: 폼 제출 시 Supabase에 저장/수정 확인
- 위험 요소: 이미지 업로드 처리 (Unsplash URL만 지원할지, 직접 업로드 지원할지 결정 필요)

**작업 3-4: 도시 삭제 API 및 UI**

- 설명: `DELETE /api/admin/cities/[slug]` 엔드포인트 구현, 삭제 확인 다이얼로그
- 예상 시간: 2시간
- 선행 작업: 3-2
- 완료 조건: 도시 삭제 시 DB에서 제거 확인
- 위험 요소: 연관 데이터(리뷰, 평가, 메트릭 등) cascade 삭제 정책 확인 필요

---

### Phase 4: 어드민 작업공간 관리 기능

**작업 4-1: 작업공간 목록 페이지 (`/admin/workspaces`)**

- 설명: 작업공간 목록 조회 및 수정/삭제 버튼 표시
- 예상 시간: 3시간
- 선행 작업: 3-1
- 완료 조건: 작업공간 목록 조회, 각 작업공간별 편집/삭제 버튼 동작
- 위험 요소: 작업공간 데이터 구조 확인 필요 (`workspaces` 테이블 스키마)

**작업 4-2: 작업공간 생성/수정 폼**

- 설명: 작업공간 추가/수정 폼 구현 (`/admin/workspaces/new`, `/admin/workspaces/[id]/edit`)
- 예상 시간: 4시간
- 선행 작업: 4-1
- 완료 조건: 폼 제출 시 Supabase에 저장/수정 확인
- 위험 요소: 이미지 업로드, 지도 좌표 입력 UI 복잡도

**작업 4-3: 작업공간 삭제 API 및 UI**

- 설명: `DELETE /api/admin/workspaces/[id]` 엔드포인트 구현, 삭제 확인 다이얼로그
- 예상 시간: 2시간
- 선행 작업: 4-1
- 완료 조건: 작업공간 삭제 시 DB에서 제거 확인
- 위험 요소: 연관 데이터(도시별 작업공간 연결) cascade 정책 확인 필요

---

### Phase 5: 리뷰 숨김 기능

**작업 5-1: 리뷰 숨김 API 구현**

- 설명: `PATCH /api/admin/reviews/[reviewId]/hide` 엔드포인트 구현 (`hidden` 토글)
- 예상 시간: 2시간
- 선행 작업: 1-2, 2-2
- 완료 조건: API 호출 시 `hidden` 필드 업데이트 확인
- 위험 요소: 없음

**작업 5-2: 어드민 리뷰 관리 UI**

- 설명: 도시 상세 페이지 리뷰 섹션에 어드민만 보이는 "숨김" 버튼 추가
- 예상 시간: 2시간
- 선행 작업: 5-1
- 완료 조건: 어드민 계정으로 리뷰 숨김 버튼 클릭 시 리뷰 목록에서 제거
- 위험 요소: 클라이언트/서버 컴포넌트 분기 처리 필요

**작업 5-3: 숨김 리뷰 조회 필터링**

- 설명: 리뷰 조회 쿼리에서 `hidden = false` 필터 추가, 어드민은 숨김 리뷰도 조회 가능
- 예상 시간: 1시간
- 선행 작업: 1-2
- 완료 조건: 일반 사용자는 숨김 리뷰 미표시, 어드민은 숨김 표시 확인
- 위험 요소: 없음

---

### Phase 6: 테스트 및 문서화

**작업 6-1: 역할 기반 접근 제어 테스트**

- 설명: 일반/어드민 계정으로 각 엔드포인트 및 페이지 접근 테스트
- 예상 시간: 3시간
- 선행 작업: 2-1, 2-2, 3-4, 4-3, 5-2
- 완료 조건: 테스트 케이스 작성 및 통과
- 위험 요소: RLS 정책 누락 시 보안 이슈

**작업 6-2: 어드민 기능 사용 가이드 작성**

- 설명: `CLAUDE.md`에 어드민 기능 사용법 추가
- 예상 시간: 1시간
- 선행 작업: 6-1
- 완료 조건: 문서 작성 완료
- 위험 요소: 없음

---

## 3. 실행 관점 정리

### 병렬 처리 가능 여부

**병렬 처리 가능:**
- 작업 1-1, 1-2 (독립적인 스키마 변경)
- 작업 3-2, 4-1 (각각 독립적인 페이지)
- 작업 3-3, 4-2 (각각 독립적인 폼)

**순차 처리 필요:**
- Phase 1 → Phase 2 (스키마 변경 후 역할 검증 로직 구현)
- Phase 2 → Phase 3/4/5 (역할 검증 후 어드민 기능 구현)
- Phase 3/4/5 → Phase 6 (기능 구현 후 테스트)

**우선순위 작업:**
1. 작업 1-1, 1-2, 1-3 (데이터베이스 기반 작업, 가장 중요)
2. 작업 2-1, 2-2 (보안 검증 로직)
3. 작업 5-1, 5-2, 5-3 (리뷰 숨김은 사용자 경험에 직접 영향)

### 테스트 계획

**기능 테스트:**
- 일반 사용자로 `/admin` 접근 시 403/리다이렉트
- 어드민으로 도시/작업공간 CRUD 정상 동작
- 리뷰 숨김 시 일반 사용자는 미표시

**통합 테스트:**
- 어드민 대시보드에서 도시 추가 → 상세 페이지에서 표시 확인
- 리뷰 숨김 → 도시 상세 페이지에서 미표시 확인

**사용자 관점 테스트:**
- 어드민이 도시를 삭제하면 일반 사용자는 해당 도시 접근 불가
- 리뷰 숨김 처리 후 일반 사용자가 리뷰 목록에서 해당 리뷰 미표시

---

## 4. 산출물 및 체크포인트

### 마일스톤

- M1: 데이터베이스 스키마 및 RLS 정책 완료 (Phase 1)
- M2: 역할 검증 로직 완료 (Phase 2)
- M3: 어드민 도시 관리 기능 완료 (Phase 3)
- M4: 어드민 작업공간 관리 기능 완료 (Phase 4)
- M5: 리뷰 숨김 기능 완료 (Phase 5)
- M6: 테스트 및 문서화 완료 (Phase 6)

### 체크포인트

- Phase 1 완료 후: RLS 정책 테스트 (일반/어드민 계정으로 각각 CRUD 시도)
- Phase 2 완료 후: 미들웨어 역할 검증 테스트 (일반 계정으로 `/admin` 접근)
- Phase 3/4 완료 후: 어드민 대시보드에서 CRUD 정상 동작 확인
- Phase 5 완료 후: 리뷰 숨김 처리 후 일반 사용자 관점에서 미표시 확인

### 문서화 항목

- `CLAUDE.md`: 어드민 기능 사용법 추가
- 마이그레이션 파일: 스키마 변경 내역 (역할, `hidden` 필드)
- API 문서: 어드민 전용 엔드포인트 목록 및 사용법

### 모니터링

- RLS 정책 위반 로그 확인 (Supabase 로그)
- 어드민 대시보드 접근 로그
- 리뷰 숨김 처리 빈도

---

## 5. 추가 원칙/조건

- 보안 우선: RLS 정책 및 미들웨어 검증 누락 시 치명적 보안 이슈 발생 가능  
- 단계적 배포: Phase 1 완료 후 프로덕션 배포, Phase 2~6은 개발 브랜치에서 진행  
- 리서치 필요 작업:  
  - 작업 3-3: 이미지 업로드 방식 결정 (Unsplash URL만 또는 Supabase Storage 직접 업로드)  
  - 작업 4-2: 지도 좌표 입력 UI 라이브러리 조사 (Mapbox, Leaflet 등)  
- 롤백 계획: Phase 1 마이그레이션 실패 시 롤백 스크립트 준비

---

## 6. 출력 형식 (체크리스트)

### Phase 1: 데이터베이스 스키마 및 권한 설정

- [ ] 1-1: `users` 테이블에 `role` 필드 추가 (1h)  
  - 완료 조건: 마이그레이션 적용, TypeScript 타입 재생성
- [ ] 1-2: `user_reviews` 테이블에 `hidden` 필드 추가 (1h)  
  - 완료 조건: 마이그레이션 적용, 리뷰 조회 쿼리 필터링 확인
- [ ] 1-3: Supabase RLS 정책 업데이트 (2h)  
  - 완료 조건: 일반/어드민 계정으로 CRUD 테스트 통과

### Phase 2: 인증 및 역할 검증 로직

- [ ] 2-1: 미들웨어에 역할 검증 추가 (2h)  
  - 완료 조건: 일반 계정으로 `/admin` 접근 시 리다이렉트
- [ ] 2-2: Server Actions에 역할 검증 헬퍼 추가 (1h)  
  - 완료 조건: `requireAdmin()` 호출 시 일반 사용자 에러 반환
- [ ] 2-3: 사용자 프로필에 역할 표시 (1h)  
  - 완료 조건: 어드민 계정 로그인 시 UI에 뱃지 표시

### Phase 3: 어드민 도시 관리 기능

- [ ] 3-1: 어드민 대시보드 레이아웃 생성 (2h)  
  - 완료 조건: `/admin` 접근 시 대시보드 표시
- [ ] 3-2: 도시 목록 페이지 (3h)  
  - 완료 조건: 도시 목록 조회, 편집/삭제 버튼 동작
- [ ] 3-3: 도시 생성/수정 폼 (4h)  
  - 완료 조건: 폼 제출 시 Supabase 저장/수정 확인
- [ ] 3-4: 도시 삭제 API 및 UI (2h)  
  - 완료 조건: 삭제 시 DB에서 제거 확인

### Phase 4: 어드민 작업공간 관리 기능

- [ ] 4-1: 작업공간 목록 페이지 (3h)  
  - 완료 조건: 작업공간 목록 조회, 편집/삭제 버튼 동작
- [ ] 4-2: 작업공간 생성/수정 폼 (4h)  
  - 완료 조건: 폼 제출 시 Supabase 저장/수정 확인
- [ ] 4-3: 작업공간 삭제 API 및 UI (2h)  
  - 완료 조건: 삭제 시 DB에서 제거 확인

### Phase 5: 리뷰 숨김 기능

- [ ] 5-1: 리뷰 숨김 API 구현 (2h)  
  - 완료 조건: API 호출 시 `hidden` 필드 업데이트
- [ ] 5-2: 어드민 리뷰 관리 UI (2h)  
  - 완료 조건: 어드민 계정으로 숨김 버튼 클릭 시 리뷰 제거
- [ ] 5-3: 숨김 리뷰 조회 필터링 (1h)  
  - 완료 조건: 일반 사용자는 숨김 리뷰 미표시

### Phase 6: 테스트 및 문서화

- [ ] 6-1: 역할 기반 접근 제어 테스트 (3h)  
  - 완료 조건: 테스트 케이스 작성 및 통과
- [ ] 6-2: 어드민 기능 사용 가이드 작성 (1h)  
  - 완료 조건: `CLAUDE.md` 업데이트

---

## 총 예상 시간

- 총 예상 시간: 약 41시간 (5~7일 소요)
