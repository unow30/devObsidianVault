
cities.likes, cites.dislikesë¥¼ usersê°€ updateí•˜ë©´ usersëŠ” ì–´ëŠ cityì˜ ì¢‹ì•„ìš” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í–ˆëŠ”ì§€ ê¸°ì–µí•˜ê³  ìˆì–´ì•¼í•œë‹¤. ë‹¤ìŒ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í…Œì´ë¸”ì„ ë§Œë“¤ê³  like, dislikeë¥¼ ì—…ë°ì´íŠ¸ í•˜ëŠ” ë¡œì§ì„ ìƒì„±í•´ë¼.
- cities.id, users.id, city_like(boolean), city_dislike(boolean), created_at, updated_atì„ ê¸°ë¡í•˜ëŠ” í…Œì´ë¸”ì„ ë§Œë“ ë‹¤.
- usersê°€ ìµœì´ˆë¡œ í•˜ë‚˜ì˜ cityì— like, dislikeí•œ ê²½ìš° ì´ í…Œì´ë¸”ì— ê¸°ë¡ì´ insertëœë‹¤.
- ì´í›„ì— í•´ë‹¹ cityì— like, dislikeí•˜ë©´ ì´ rowì— ì—…ë°ì´íŠ¸ê°€ ëœë‹¤.
- userê°€ likeë¡œ ì—…ë°ì´íŠ¸í•˜ë©´ likeëŠ” true, dislikeëŠ” falseê°€ ë˜ì–´ì•¼í•œë‹¤.
- uiì—ì„œ ë‚´ê°€ like, dislikeë¥¼ í•œ ìƒíƒœê°€ ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€ë˜ì–´ì•¼í•œë‹¤.
- ê°™ì€ ê°’ìœ¼ë¡œ ë‹¤ì‹œ updateí•  ìˆ˜ ì—†ë‹¤. uië‹¨ì—ì„œ ì²˜ë¦¬í•œë‹¤.
- citiesí…Œì´ë¸”ì˜ likes, dislikesë„ ê°™ì´ ì—…ë°ì´íŠ¸ ë˜ì–´ì•¼í•œë‹¤.
- userê°€ likeë¥¼ ëˆ„ë¥´ë©´ likesê°€ +1ë˜ê³  dislikeë¥¼ ëˆ„ë¥´ë©´ dislikesê°€ +1 ë˜ì–´ì•¼ í•œë‹¤.
- cityì— likeë¥¼ ëˆ„ë¥¸ userê°€ dislikeë¥¼ ëˆ„ë¥´ë©´ dislike +1ë˜ê³  like -1ëœë‹¤.
- cityì— dislikeë¥¼ ëˆ„ë¥¸ userê°€ likeë¥¼ ëˆ„ë¥´ë©´ dislike +1, like -1ëœë‹¤.

---
 1. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ âœ…

  - user_city_reactions í…Œì´ë¸” ìƒì„±
  (supabase/migrations/20260119014022_create_user_city_reactions.sql)
    - user_id, city_id, city_like, city_dislike, created_at, updated_at
    - unique constraint: (user_id, city_id)
    - check constraint: likeì™€ dislike ë™ì‹œ true ë°©ì§€
    - RLS ì •ì±…: ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë°˜ì‘ë§Œ ì¡°íšŒ/ìˆ˜ì • ê°€ëŠ¥

  2. ìë™ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±° âœ…

  - cities.likes, cities.dislikesê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤
    - like ëˆ„ë¥´ë©´: likes +1
    - dislike ëˆ„ë¥´ë©´: dislikes +1
    - like â†’ dislike ì „í™˜: likes -1, dislikes +1
    - dislike â†’ like ì „í™˜: dislikes -1, likes +1

  3. Server Actions âœ… (app/actions/city-reactions.ts)

  - toggleCityReaction: ì¢‹ì•„ìš”/ì‹«ì–´ìš” í† ê¸€
  - getCityReaction: ë‹¨ì¼ ë„ì‹œ ë°˜ì‘ ì¡°íšŒ
  - getCityReactions: ì—¬ëŸ¬ ë„ì‹œ ë°˜ì‘ ì¼ê´„ ì¡°íšŒ (ì„±ëŠ¥ ìµœì í™”)

  4. UI ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸ âœ…

  - LikeDislikeButtons (components/city/LikeDislikeButtons.tsx)
    - Server Action ì—°ë™
    - ë‚™ê´€ì  UI ì—…ë°ì´íŠ¸ (useTransition)
    - ì—ëŸ¬ ë°œìƒ ì‹œ ë¡¤ë°±
    - ë¡œê·¸ì¸ í•„ìš” ì‹œ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
  - CityCardGrid (components/city/CityCardGrid.tsx)
    - ì„œë²„ ì»´í¬ë„ŒíŠ¸ë¡œ ëª¨ë“  ë„ì‹œì˜ ë°˜ì‘ ìƒíƒœë¥¼ í•œ ë²ˆì— ì¡°íšŒ (ì„±ëŠ¥ ìµœì í™”)
  - CityCard (components/city/CityCard.tsx)
    - ì‚¬ìš©ì ë°˜ì‘ ìƒíƒœë¥¼ ë°›ì•„ì„œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
  - ë„ì‹œ ìƒì„¸ í˜ì´ì§€ (app/city/[citySlug]/page.tsx)
    - ì‚¬ìš©ì ë°˜ì‘ ì¡°íšŒ í›„ CityDetailHeroì— ì „ë‹¬

  5. íŠ¹ì§• âœ¨

  - âœ… ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ìƒíƒœ ìœ ì§€: DBì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤
  - âœ… ê°™ì€ ê°’ ì¤‘ë³µ ì—…ë°ì´íŠ¸ ë°©ì§€: UIì—ì„œ ì²˜ë¦¬
  - âœ… ìë™ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸: PostgreSQL íŠ¸ë¦¬ê±°ê°€ cities í…Œì´ë¸” ìë™ ì—…ë°ì´íŠ¸
  - âœ… ì„±ëŠ¥ ìµœì í™”: ì—¬ëŸ¬ ë„ì‹œì˜ ë°˜ì‘ì„ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ì¡°íšŒ
  - âœ… ë‚™ê´€ì  UI: ì¦‰ê°ì ì¸ í”¼ë“œë°±, ì—ëŸ¬ ì‹œ ë¡¤ë°±

  6. ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© âœ…

  - Supabase ë¡œì»¬ DB ë¦¬ì…‹ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì™„ë£Œ
  - TypeScript íƒ€ì… ì¬ìƒì„± ì™„ë£Œ


---

ì™„ë£Œëœ ì‘ì—…

  1. âœ… í…Œì´ë¸” í†µí•© ë§ˆì´ê·¸ë ˆì´ì…˜
  (supabase/migrations/20260119034300_fix_user_tables.sql:1)

  - users í…Œì´ë¸” ì œê±°
  - user_reviews, user_ratings, user_city_reactions FKë¥¼ profiles ì°¸ì¡°ë¡œ ë³€ê²½
  - ì¤‘ë³µ íŠ¸ë¦¬ê±° handle_new_user_v2() ì œê±°

  2. âœ… lib/supabase-queries.ts ìˆ˜ì •

  - SupabaseClient íƒ€ì… import ì¶”ê°€ (lib/supabase-queries.ts:5)
  - ì“°ê¸° í•¨ìˆ˜ë“¤ì´ ì„¸ì…˜ í¬í•¨ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ë„ë¡ ìˆ˜ì •:
    - submitRating() (lib/supabase-queries.ts:244)
    - deleteRating() (lib/supabase-queries.ts:338)
    - createReview() (lib/supabase-queries.ts:438)
    - updateReview() (lib/supabase-queries.ts:466)
    - deleteReview() (lib/supabase-queries.ts:490)

  3. âœ… getCityReviews JOIN ìˆ˜ì • (lib/supabase-queries.ts:412)

  - users í…Œì´ë¸” â†’ profiles í…Œì´ë¸” ì°¸ì¡°ë¡œ ë³€ê²½
  - username â†’ display_name
  - profile_image â†’ avatar_url

  4. âœ… API Route ìˆ˜ì •

  - app/api/cities/[slug]/reviews/route.ts:87 - createReview í˜¸ì¶œ ì‹œ í´ë¼ì´ì–¸íŠ¸ ì „ë‹¬
  - app/api/cities/[slug]/ratings/route.ts:94 - submitRating í˜¸ì¶œ ì‹œ í´ë¼ì´ì–¸íŠ¸ ì „ë‹¬
  - app/api/cities/[slug]/ratings/route.ts:166 - deleteRating í˜¸ì¶œ ì‹œ í´ë¼ì´ì–¸íŠ¸ ì „ë‹¬
  - app/api/cities/[slug]/reviews/[reviewId]/route.ts:78 - updateReview í˜¸ì¶œ ì‹œ
  í´ë¼ì´ì–¸íŠ¸ ì „ë‹¬
  - app/api/cities/[slug]/reviews/[reviewId]/route.ts:132 - deleteReview í˜¸ì¶œ ì‹œ
  í´ë¼ì´ì–¸íŠ¸ ì „ë‹¬

  5. âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ë° ê²€ì¦

  - Supabase ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤ ë¦¬ì…‹ ì™„ë£Œ
  - TypeScript íƒ€ì… ì¬ìƒì„± ì™„ë£Œ
  - ë¹Œë“œ ì„±ê³µ - íƒ€ì… ì˜¤ë¥˜ ì—†ìŒ

  ì£¼ìš” ë³€ê²½ ì‚¬í•­

  ê·¼ë³¸ ì›ì¸ í•´ê²°

  1. í…Œì´ë¸” ì¶©ëŒ ì œê±°: users í…Œì´ë¸”ì„ ì™„ì „íˆ ì œê±°í•˜ê³  profilesë¡œ í†µì¼
  2. ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ ë¬¸ì œ í•´ê²°: ì“°ê¸° ì‘ì—… ì‹œ ì„¸ì…˜ì´ í¬í•¨ëœ Supabase í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©

  RLS ì •ì±… ì‘ë™ ë°©ì‹

  - ì´ì œ ëª¨ë“  ì“°ê¸° ì‘ì—…ì´ auth.uid()ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë°˜í™˜
  - RLS ì •ì±…: WITH CHECK (auth.uid() = user_id) ì •ìƒ ì‘ë™
  - profiles í…Œì´ë¸”ê³¼ì˜ FK ì œì•½ ì¡°ê±´ë„ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë¨

  í…ŒìŠ¤íŠ¸ ë°©ë²•

  ë¡œì»¬ ê°œë°œ ì„œë²„ë¥¼ ì‹œì‘í•˜ê³  í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

  npm run dev

  í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

  1. íšŒì›ê°€ì…: ìƒˆ ì‚¬ìš©ì ìƒì„± â†’ profiles í…Œì´ë¸”ì— ìë™ ìƒì„± í™•ì¸
  2. í‰ê°€ ì‘ì„±: ë¡œê·¸ì¸ í›„ ë„ì‹œ ìƒì„¸ í˜ì´ì§€ì—ì„œ ë³„ì  í‰ê°€ â†’ RLS ìœ„ë°˜ ì—†ì´ ì„±ê³µ
  3. ë¦¬ë·° ì‘ì„±: ë¡œê·¸ì¸ í›„ ë¦¬ë·° ì‘ì„± â†’ ì¦‰ì‹œ ë¦¬ë·° ëª©ë¡ì— í‘œì‹œ
  4. ì‘ì„±ì ì •ë³´: ë¦¬ë·° ëª©ë¡ì—ì„œ profilesì˜ display_nameê³¼ avatar_url ì˜¬ë°”ë¥´ê²Œ í‘œì‹œ


---

â•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œ
 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ìˆ˜ì • ê³„íš

 ğŸ“Š ì‹¤íŒ¨ ë¶„ì„ ê²°ê³¼

 ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼:
 - ì´ í…ŒìŠ¤íŠ¸: ì•½ 200ê°œ
 - ì‹¤íŒ¨: ì•½ 130ê°œ
 - ì„±ê³µ: ì•½ 70ê°œ
 - ì‹¤íŒ¨ìœ¨: 65%

 ğŸ” ì£¼ìš” ì‹¤íŒ¨ ì›ì¸

 1ï¸âƒ£ jsdom í™˜ê²½ ëˆ„ë½ (ìµœìš°ì„ 

 ì¦ìƒ: ReferenceError: document is not defined

 ì˜í–¥ë°›ëŠ” íŒŒì¼ë“¤:
 - components/city/CityCard.test.tsx (18ê°œ ì‹¤íŒ¨)
 - components/city/ReviewForm.test.tsx (12ê°œ ì‹¤íŒ¨)
 - components/city/RatingForm.test.tsx (11ê°œ ì‹¤íŒ¨)
 - components/city/CityCardGrid.test.tsx (7ê°œ ì‹¤íŒ¨)
 - components/filters/FilterBar.test.tsx (15ê°œ ì‹¤íŒ¨)
 - components/city/LikeDislikeButtons.test.tsx (12ê°œ ì‹¤íŒ¨)
 - app/login/page.test.tsx (11ê°œ ì‹¤íŒ¨)
 - app/register/page.test.tsx (14ê°œ ì‹¤íŒ¨)
 - app/page.test.tsx (12ê°œ ì‹¤íŒ¨)
 - ê¸°íƒ€ React ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ë“¤

 ì›ì¸: React ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒë‹¨ì— /** @vitest environment jsdom */ ì£¼ì„ì´ ëˆ„ë½ë¨

 í•´ê²°:
 /**
  * @vitest-environment jsdom
  */
 import { describe, it, expect } from "vitest";
 // ... rest of the test

 ---
 2ï¸âƒ£ Supabase Mock ì„¤ì • ì˜¤ë¥˜

 ì¦ìƒ:
 Failed to fetch city stats: {
   code: 'PGRST301',
   message: 'Expected 3 parts in JWT; got 1'
 }

 ì˜í–¥ë°›ëŠ” íŒŒì¼: lib/supabase-queries.test.ts (23ê°œ ì¤‘ ì¼ë¶€ ì‹¤íŒ¨)

 ì›ì¸:
 - lib/supabase-queries.tsì—ì„œ Supabase í´ë¼ì´ì–¸íŠ¸ë¥¼ ì§ì ‘ ìƒì„±í•˜ê³  exportí•˜ê³  ìˆìŒ
 - Mockì´ @/utils/supabase/clientë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” íŒŒì¼ ë‚´ë¶€ì—ì„œ
 createClientë¥¼ ì§ì ‘ í˜¸ì¶œ
 - Mockë˜ì§€ ì•Šì€ ì‹¤ì œ Supabase ì¸ìŠ¤í„´ìŠ¤ê°€ í˜¸ì¶œë˜ì–´ ì¸ì¦ ì—ëŸ¬ ë°œìƒ

 ì‹¤ì œ ì½”ë“œ (lib/supabase-queries.ts:12):
 export const supabase = createClient<Database>(supabaseUrl, supabaseKey);

 í•´ê²°:
 1. Mock ê²½ë¡œë¥¼ lib/supabase-queriesë¡œ ë³€ê²½í•˜ì—¬ supabase exportë¥¼ ì§ì ‘ mock
 2. ë˜ëŠ” @supabase/supabase-jsì˜ createClientë¥¼ mock

 ---
 3ï¸âƒ£ Mock ì¿¼ë¦¬ ë¹Œë” ì²´ì´ë‹ ë¶ˆì™„ì „

 ì¦ìƒ:
 TypeError: supabaseClient.from(...).delete(...).eq(...).eq is not a function

 ì˜í–¥ë°›ëŠ” í…ŒìŠ¤íŠ¸: deleteReview() ê´€ë ¨ í…ŒìŠ¤íŠ¸

 ì›ì¸: Mock ì¿¼ë¦¬ ë¹Œë”ê°€ ë‹¤ì¤‘ ì²´ì´ë‹ (.eq().eq())ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ

 í•´ê²°: ì¿¼ë¦¬ ë¹Œë” mockì—ì„œ ê° ë©”ì„œë“œê°€ thisë¥¼ ë¦¬í„´í•˜ë„ë¡ ìˆ˜ì •
 const queryBuilder = {
   delete: vi.fn().mockReturnThis(),
   eq: vi.fn().mockReturnThis(),  // ì²« ë²ˆì§¸ eq
   // ë‘ ë²ˆì§¸ eq í˜¸ì¶œë„ ì§€ì›í•˜ë„ë¡
 };

 ---
 4ï¸âƒ£ Mock ë°ì´í„° êµ¬ì¡° ë¶ˆì¼ì¹˜

 ì¦ìƒ:
 - expected [] to have a length of 1 but got +0
 - Cannot read properties of undefined (reading 'authorName')

 ì˜í–¥ë°›ëŠ” í…ŒìŠ¤íŠ¸:
 - getCityReviews() ê´€ë ¨ í…ŒìŠ¤íŠ¸
 - getCityAverageRating() ê´€ë ¨ í…ŒìŠ¤íŠ¸

 ì›ì¸: Mock ì¿¼ë¦¬ ë¹Œë”ì˜ ì‘ë‹µ êµ¬ì¡°ê°€ ì‹¤ì œ ì‘ë‹µê³¼ ë‹¤ë¦„

 í•´ê²°: Mock ì‘ë‹µ ë°ì´í„°ë¥¼ ì‹¤ì œ Supabase ì‘ë‹µ í˜•ì‹ê³¼ ì¼ì¹˜ì‹œí‚¤ê¸°
 const mockQueryBuilder = {
   select: vi.fn().mockReturnThis(),
   eq: vi.fn().mockReturnThis(),
   order: vi.fn().mockReturnThis(),
   limit: vi.fn().mockResolvedValue({
     data: [mockReview],  // ì‹¤ì œ ë°ì´í„° ì œê³µ
     error: null,
   }),
 };

 ---
 5ï¸âƒ£ Async ì„œë²„ ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ ë¬¸ì œ

 ì¦ìƒ:
 - app/page.test.tsx, app/login/page.test.tsx, app/register/page.test.tsxì—ì„œ ë Œë”ë§
 ì‹¤íŒ¨

 ì›ì¸: Next.js 15ì˜ async ì„œë²„ ì»´í¬ë„ŒíŠ¸ë¥¼ ì œëŒ€ë¡œ í…ŒìŠ¤íŠ¸í•˜ì§€ ëª»í•¨

 í•´ê²°:
 // Before
 const { container } = render(<LoginPage searchParams={{}} />);

 // After
 const { container } = render(
   await LoginPage({ searchParams: Promise.resolve({}) })
 );

 ---
 6ï¸âƒ£ Mock í•¨ìˆ˜ í˜¸ì¶œ ê²€ì¦ ì‹¤íŒ¨

 ì¦ìƒ: expected "vi.fn()" to be called with arguments: [ 20 ]

 ì›ì¸: Mock í•¨ìˆ˜ê°€ ì‹¤ì œë¡œ í˜¸ì¶œë˜ì§€ ì•Šê±°ë‚˜, ë‹¤ë¥¸ mock ì¸ìŠ¤í„´ìŠ¤ê°€ í˜¸ì¶œë¨

 í•´ê²°: Mock ì„¤ì • í›„ ì‹¤ì œë¡œ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ëŠ”ì§€ í™•ì¸

 ---
 ğŸ›  ìˆ˜ì • ê³„íš

 Phase 1: jsdom í™˜ê²½ ì¶”ê°€ (ìš°ì„ ìˆœìœ„ 1)

 ëŒ€ìƒ íŒŒì¼ (ëª¨ë“  React ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸):
 - components/city/CityCard.test.tsx
 - components/city/CityCardGrid.test.tsx
 - components/city/CityDetailHero.test.tsx
 - components/city/RatingForm.test.tsx
 - components/city/ReviewForm.test.tsx
 - components/city/ReviewSection.test.tsx
 - components/city/WeatherChart.test.tsx
 - components/city/AqiChart.test.tsx
 - components/city/CostBreakdownChart.test.tsx
 - components/layout/Header.test.tsx
 - components/layout/UserMenu.test.tsx
 - components/auth/submit-button.test.tsx
 - components/filters/FilterBar.test.tsx
 - app/login/page.test.tsx
 - app/register/page.test.tsx
 - app/page.test.tsx
 - app/city/[citySlug]/page.test.tsx
 - app/layout.test.tsx
 - components/city/LikeDislikeButtons.test.tsx

 ìˆ˜ì • ë°©ë²•:
 ê° íŒŒì¼ ì²« ì¤„ì— ë‹¤ìŒ ì£¼ì„ ì¶”ê°€:
 /**
  * @vitest-environment jsdom
  */

 ì˜ˆìƒ íš¨ê³¼: ì•½ 100ê°œ í…ŒìŠ¤íŠ¸ ìˆ˜ì •

 ---
 Phase 2: Supabase Mock ê°œì„  (ìš°ì„ ìˆœìœ„ 2)

 ëŒ€ìƒ íŒŒì¼: lib/supabase-queries.test.ts

 ìˆ˜ì • ë‚´ìš©:
 1. Mock ê²½ë¡œ ë³€ê²½:
 // Before
 vi.mock("@/utils/supabase/client", () => ({
   supabase: { from: vi.fn() },
 }));

 // After
 vi.mock("lib/supabase-queries", async () => {
   const actual = await vi.importActual<typeof import("@/lib/supabase-queries")>(
     "@/lib/supabase-queries"
   );
   return {
     ...actual,
     supabase: {
       from: vi.fn(),
     },
   };
 });

 2. ì¿¼ë¦¬ ë¹Œë” ì²´ì´ë‹ ê°œì„ :
 function createQueryBuilder() {
   const builder: any = {
     select: vi.fn().mockReturnValue(builder),
     eq: vi.fn().mockReturnValue(builder),
     gte: vi.fn().mockReturnValue(builder),
     lte: vi.fn().mockReturnValue(builder),
     contains: vi.fn().mockReturnValue(builder),
     ilike: vi.fn().mockReturnValue(builder),
     order: vi.fn().mockReturnValue(builder),
     range: vi.fn().mockReturnValue(builder),
     limit: vi.fn().mockReturnValue(builder),
     delete: vi.fn().mockReturnValue(builder),
     insert: vi.fn().mockReturnValue(builder),
     update: vi.fn().mockReturnValue(builder),
     single: vi.fn().mockResolvedValue({ data: null, error: null }),
   };
   return builder;
 }

 3. Mock ë°ì´í„° ì‘ë‹µ ìˆ˜ì •:
 - getCityReviews í…ŒìŠ¤íŠ¸ì—ì„œ ì˜¬ë°”ë¥¸ ë°ì´í„° êµ¬ì¡° ì œê³µ
 - getCityAverageRating í…ŒìŠ¤íŠ¸ì—ì„œ ì˜¬ë°”ë¥¸ ì‘ë‹µ ì œê³µ

 ì˜ˆìƒ íš¨ê³¼: ì•½ 20ê°œ í…ŒìŠ¤íŠ¸ ìˆ˜ì •

 ---
 Phase 3: ê¸°íƒ€ Mock ìˆ˜ì • (ìš°ì„ ìˆœìœ„ 3)

 ëŒ€ìƒ:
 - components/city/CityCardGrid.test.tsx - getCityReactions mock
 - app/page.test.tsx - getCitiesList mock ì‘ë‹µ
 - components/filters/FilterBar.test.tsx - useRouter mock

 ìˆ˜ì • ë‚´ìš©:
 1. Async ì„œë²„ ì»´í¬ë„ŒíŠ¸ await ì²˜ë¦¬
 2. Mock í•¨ìˆ˜ í˜¸ì¶œ ê²€ì¦ ê°œì„ 
 3. Mock ë°ì´í„° êµ¬ì¡° ì‹¤ì œì™€ ì¼ì¹˜ì‹œí‚¤ê¸°

 ì˜ˆìƒ íš¨ê³¼: ì•½ 10ê°œ í…ŒìŠ¤íŠ¸ ìˆ˜ì •

 ---
 ğŸ“ ìˆ˜ì •í•  íŒŒì¼ ëª©ë¡

 4. jsdom í™˜ê²½ ì¶”ê°€ (19ê°œ íŒŒì¼)

 components/city/CityCard.test.tsx
 components/city/CityCardGrid.test.tsx
 components/city/CityDetailHero.test.tsx
 components/city/RatingForm.test.tsx
 components/city/ReviewForm.test.tsx
 components/city/ReviewSection.test.tsx
 components/city/WeatherChart.test.tsx
 components/city/AqiChart.test.tsx
 components/city/CostBreakdownChart.test.tsx
 components/layout/Header.test.tsx
 components/layout/UserMenu.test.tsx
 components/auth/submit-button.test.tsx
 components/filters/FilterBar.test.tsx
 app/login/page.test.tsx
 app/register/page.test.tsx
 app/page.test.tsx
 app/city/[citySlug]/page.test.tsx
 app/layout.test.tsx
 components/city/LikeDislikeButtons.test.tsx

 5. Supabase Mock ìˆ˜ì • (1ê°œ íŒŒì¼)

 lib/supabase-queries.test.ts

 6. ê¸°íƒ€ Mock ìˆ˜ì • (í•„ìš”ì‹œ)

 components/city/CityCardGrid.test.tsx
 app/page.test.tsx
 components/filters/FilterBar.test.tsx

 ---
 âœ… ê²€ì¦ ë°©ë²•

 ë‹¨ê³„ë³„ ê²€ì¦

 # Phase 1: jsdom í™˜ê²½ ì¶”ê°€ í›„
 npm run test components/city/CityCard.test.tsx
 npm run test components/city/ReviewForm.test.tsx

 # Phase 2: Supabase mock ìˆ˜ì • í›„
 npm run test lib/supabase-queries.test.ts

 # Phase 3: ì „ì²´ í…ŒìŠ¤íŠ¸
 npm run test

 ì„±ê³µ ê¸°ì¤€

 - âœ… ì „ì²´ í…ŒìŠ¤íŠ¸ ì¤‘ 90% ì´ìƒ í†µê³¼ (180ê°œ+/200ê°œ)
 - âœ… ê° ìš°ì„ ìˆœìœ„ë³„ ì£¼ìš” í…ŒìŠ¤íŠ¸ íŒŒì¼ë“¤ 100% í†µê³¼
 - âœ… CI/CDì—ì„œ í…ŒìŠ¤íŠ¸ í†µê³¼

 ---
 ğŸ¯ ì˜ˆìƒ ê²°ê³¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  Phase  â”‚     ëŒ€ìƒ      â”‚ ìˆ˜ì • ì˜ˆìƒ í…ŒìŠ¤íŠ¸ ìˆ˜ â”‚ ëˆ„ì  ì„±ê³µë¥  â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚ í˜„ì¬    â”‚ -             â”‚ 70ê°œ                â”‚ 35%         â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚ Phase 1 â”‚ jsdom í™˜ê²½    â”‚ +100ê°œ              â”‚ 85%         â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚ Phase 2 â”‚ Supabase mock â”‚ +20ê°œ               â”‚ 95%         â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚ Phase 3 â”‚ ê¸°íƒ€          â”‚ +10ê°œ               â”‚ 100%        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 ---
 ğŸš¨ ì£¼ì˜ì‚¬í•­

 1. jsdom ì£¼ì„ í˜•ì‹: @vitest-environment (í•˜ì´í”ˆ í•„ìš”)
 2. Mock ê²½ë¡œ: ì‹¤ì œ import ê²½ë¡œì™€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨
 3. Async ì²˜ë¦¬: ì„œë²„ ì»´í¬ë„ŒíŠ¸ëŠ” ë°˜ë“œì‹œ await ì²˜ë¦¬
 4. Mock ì²´ì´ë‹: ëª¨ë“  ì¿¼ë¦¬ ë©”ì„œë“œê°€ this ë¦¬í„´í•˜ë„ë¡

 ---
 ğŸ“Œ í•µì‹¬ íŒŒì¼ ê²½ë¡œ

 ìˆ˜ì • ëŒ€ìƒ:
 - /Users/yunhokim/Documents/nomad/lib/supabase-queries.test.ts
 - /Users/yunhokim/Documents/nomad/components/**/*.test.tsx (19ê°œ íŒŒì¼)
 - /Users/yunhokim/Documents/nomad/app/**/*.test.tsx (4ê°œ íŒŒì¼)

 ì°¸ê³  íŒŒì¼:
 - /Users/yunhokim/Documents/nomad/lib/supabase-queries.ts (Mock ëŒ€ìƒ í™•ì¸)
 - /Users/yunhokim/Documents/nomad/__mocks__/supabase.ts (ê¸°ì¡´ Mock íŒ¨í„´)
â•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œ