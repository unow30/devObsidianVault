#aws, #elastic-beanstalk, #auto-scailing
elastic beanstalk(eb)의 비용 효율성을 위해 시간 기반 크기 조정을 설정했다.
이 설정으로 인스턴스가 11시에 새로 생성되고 20시에 제거되도록 만들었다.

이 설정은 잘 작동했으나, 새로 생성되는 인스턴스가 https 요청을 받지 못하는 것을 확인하였다. https 주소로 요청을 보내면 503 에러가 뜬다.

**503 Service Temporarily Unavailable**

내가 설정한 로드밸런서의 작동과정은 다음과 같다.
1. 로드밸런서에 연결된 기본 ssl/tls 인증서(https 도메인 주소 포함)로 https 들어오는 요청(443포트 리스닝)을 기본 작업: 대상그룹으로 전달한다.
2. 대상그룹에서 ec2로 요청을 전달하는데, 이는 ec2의 보안그룹 인바운드 규칙으로 열어둔80번 포트에서 이루어진다.
3. 80번 포트로 요청을 받은 ec2는 웹서버인 nginx의 리버스 프록시를 이용해 내부 3000포트로 실행중인 앱서버로 요청을 보낸다. 요청에 대한 응답은 역순으로 전달된다.

여기서 대상그룹에 등록한 인스턴스가 제거되고 재생성 되는 과정에서 대상그룹에 새로 등록되지 않아서 생기는 이슈였다. 해당 대상그룹을 찾아가보니 등록된 대상이 비어있었다.

해결방안은 해당 ec2의 auto scailing 그룹을 찾아가 대상그룹을 직접 등록하는 것이다.
eb로 시간 기반 크기 조정을 생성한 덕분에 auto scailing 그룹에 다음과 같은 그룹이 생성된다.
	  ![[Pasted Graphic.png]]
이름을 클릭하고 통합 - 새로 만들기 탭에 로드 밸런싱을 편집할 수 있다.
	  ![[Pasted Graphic 1.png]]

대상 그룹을 선택하고 업데이트를 누르면 끝이다. 대상 그룹에는 새로 실행된 인스턴스를 미리 등록하도록 한다.
	![[편집 awseb-e-hr653qs3ja-stack-AWSEBAutoScalingGroup-15kmt.png]]

이제 시간 기반 크기 조정을 진행해도 대상그룹을 적용하여 인스턴스가 생성될 것이다.
실험을 위해 시간 기반 크기 조정을 수정하였다.
16시 10분에 인스턴스 수가 0개가 되고 16시 13분에 인스턴스 개수가 1이 된다.
	![[Pasted image 20250330160103.png]]

16시 10분 로드밸런서 대상 그룹의 등록이 자동으로 취소되었다
https 요청은 502 Bad Gateway로 표시중
Draining: 인스턴스가 종료되기 전에 진행중인 요청을 완료할 수 있다. 이를 기다리는 중
	![[스크린샷 2025-03-30 오후 4.10.33.png]]

16시 13분
새로운 인스턴스에 대한 대상이 생성되었으나 아직 ec2가 실행중인 상태
![[스크린샷 2025-03-30 오후 4.14.38.png]]

16시 18분
실행 준비과정을 거쳐서 https 요청 성공. 실행중 시간을 고려하여 시간 기반 크기 조정을 해야겠다.
	![[스크린샷 2025-03-30 오후 4.21.26.png|400x400]]